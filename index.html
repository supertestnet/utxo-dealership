<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, user-scalable=no">
        <script src="https://bitcoincore.tech/apps/bitcoinjs-ui/lib/bitcoinjs-lib.js"></script>
        <script src="https://bundle.run/browserify-cipher@1.0.1"></script>
        <script src="https://unpkg.com/@cmdcode/tapscript@1.4.0"></script>
        <script src="https://bundle.run/noble-secp256k1@1.2.14"></script>
        <style>
            * {
                box-sizing: border-box;
                font-size: 1.15rem;
                font-family: Arial, sans-serif;
            }
            html {
                max-width: 70ch;
                padding: 3rem 1rem;
                margin: auto;
                line-height: 1.25;
            }
            h1 {
                font-size: 2rem;
            }
            h2 {
                font-size: 1.5rem;
            }
            input {
                line-height: 1.25;
                width: 100%;
                height: 1.8rem;
                font-size: 1.15rem;
                border: 1px solid grey;
            }
            @media screen and (max-width: 600px) {
            }
        </style>
        <script>
            var $ = document.querySelector.bind( document );
            var $$ = document.querySelectorAll.bind( document );
            var url_params = new URLSearchParams( window.location.search );
            var url_keys = url_params.keys();
            var $_GET = {}
            for ( var key of url_keys ) $_GET[ key ] = url_params.get( key );
        </script>
        <script>
            var { getSharedSecret, schnorr, utils } = nobleSecp256k1;
            var crypto  = window.crypto;
            var sha256  = bitcoinjs.crypto.sha256;
            var keypair = bitcoinjs.ECPair.makeRandom();
            var privKey = keypair.privateKey.toString( "hex" );
            var pubKey  = keypair.publicKey.toString( "hex" );
            pubKey      = pubKey.substring( 2 );
            console.log( pubKey );
            var relay = "wss://nos.lol";
            var socket = new WebSocket( relay );
            socket.addEventListener('message', async function( message ) {
                var [ type, subId, event ] = JSON.parse( message.data );
                var { kind, content } = event || {}
                if (!event || event === true) return;
                // console.log('message:', event);
                if (kind === 4) {
                    content = await decrypt(privKey, event.pubkey, content);
                    content = JSON.parse( content );
                    if ( content[ "type" ] == "accept" ) {
                        var info_for_seller = content[ "msg" ];
                        var buyers_contract = info_for_seller[ "buyers_contract" ];
                        var buyers_address = info_for_seller[ "buyers_address" ];
                        var buyers_contract = buyers_contract;
                        var txinfo = await dealership.addressReceivedMoneyInThisTx( buyers_contract.address, "testnet/" )
                        // var txid = prompt( "enter the txid you just entered" );
                        // var vout = prompt( "and the vout you just entered" );
                        // vout = Number( vout );
                        // var txinfo = [txid, vout, 4000];
                        // var txinfo = ["ab".repeat( 32 ), 0, 4000];
                        if ( txinfo[ 2 ] != 4_000 ) return;
                        dealership[ "buyer_txid" ] = txinfo[ 0 ];
                        dealership[ "buyer_vout" ] = txinfo[ 1 ];
                        dealership[ "buyer_address" ] = buyers_address;
                        dealership.buyers_contract.contract = buyers_contract;
                        var sellers_privkey = sessionStorage[ "sellers_privkey" ];
                        await dealership.prepSeller( sellers_privkey );
                        $( 'h2' ).remove();
                        // $( '.buy_utxo' ).style.display = "none";
                        var hd = document.createElement( "h2" );
                        hd.innerText = "ok you're the seller now, send 3000 sats to this address:";
                        $( '.procedure' ).append( hd );
                        var pg = document.createElement( "p" );
                        console.log( 3000, dealership.sellers_contract.contract.address );
                        pg.innerText = dealership.sellers_contract.contract.address;
                        $( '.procedure' ).append( pg );
                        await dealership.waitSomeSeconds( 3 );
                        await dealership.loopTilAddressReceivesMoney( dealership.sellers_contract.contract.address, "testnet/" );
                        var txinfo = await dealership.addressReceivedMoneyInThisTx( dealership.sellers_contract.contract.address, "testnet/" );
                        // var txid = prompt( "enter the txid" );
                        // var vout = prompt( "and the vout" );
                        // vout = Number( vout );
                        // var txinfo = [txid, vout, 3000];
                        // var txinfo = ["ab".repeat( 32 ), 0, 4000];
                        dealership[ "seller_txid" ] = txinfo[ 0 ];
                        dealership[ "seller_vout" ] = txinfo[ 1 ];
                        var another_bitcoin_address = "miCsGRg9GTKWfKDPGUhQ2jf5srtD4e9M2Q";
                        dealership[ "seller_address" ] = another_bitcoin_address;
                        var sellers_contract = dealership.sellers_contract.contract;
                        $( 'h2' ).remove();
                        $( 'p' ).remove();
                        var hd = document.createElement( "h2" );
                        hd.innerText = "ok send this to the buyer:";
                        $( '.procedure' ).append( hd );
                        var pg = document.createElement( "p" );
                        pg.innerText = JSON.stringify( {sellers_address: another_bitcoin_address, sellers_contract} );
                        $( '.procedure' ).append( pg );
                        var btn3 = document.createElement( "button" );
                        btn3.classList.add( "info_sent" );
                        btn3.innerText = "click when the info is sent";
                        sessionStorage[ "info_for_buyer" ] = JSON.stringify( {sellers_address: another_bitcoin_address, sellers_contract} );
                        setNostrNote( encrypt( privKey, event.pubkey, JSON.stringify( {type: "info_for_buyer", msg: {sellers_address: another_bitcoin_address, sellers_contract}} ) ), event.pubkey, relay );
                    }
                    if ( content[ "type" ] == "info_for_buyer" ) {
                        console.log('content:', content);
                        var info_for_buyer = content[ "msg" ];
                        var sellers_contract = info_for_buyer[ "sellers_contract" ];
                        var sellers_address = info_for_buyer[ "sellers_address" ];
                        var txinfo = await dealership.addressReceivedMoneyInThisTx( sellers_contract.address, "testnet/" )
                        // var txid = prompt( "enter the txid you just entered" );
                        // var vout = prompt( "and the vout you just entered" );
                        // vout = Number( vout );
                        // var txinfo = [txid, vout, 3000];
                        // var txinfo = ["ab".repeat( 32 ), 0, 3000];
                        if ( txinfo[ 2 ] != 3_000 ) return;
                        dealership[ "seller_txid" ] = txinfo[ 0 ];
                        dealership[ "seller_vout" ] = txinfo[ 1 ];
                        dealership[ "seller_address" ] = sellers_address;
                        dealership.sellers_contract.contract = sellers_contract;
                        var buyer_sig = await dealership.signContractAsBuyer()
                        var buyer_preimage = dealership.buyers_contract.preimage;
                        var hd = document.createElement( "h2" );
                        hd.innerText = "waiting for the seller's sats";
                        $( '.procedure' ).append( hd );
                        setNostrNote( encrypt( privKey, event.pubkey, JSON.stringify( {type: "more_info_for_seller", msg: {buyer_sig, buyer_preimage}} ) ), event.pubkey, relay );
                        $( 'h2' ).remove();
                    }
                    if ( content[ "type" ] == "more_info_for_seller" ) {
                        console.log('content:', content);
                        var more_info_for_seller = content[ "msg" ];
                        var hash = await dealership.sha256( dealership.hexToBytes( more_info_for_seller[ "buyer_preimage" ] ) );
                        if ( hash != dealership.sellers_contract.contract.hash ) return;
                        var buyer_sig = more_info_for_seller[ "buyer_sig" ];
                        var txhex = await dealership.useMultisigAsSeller( dealership.sellers_contract.privkey2, buyer_sig );
                        alert( `ok you're the seller now -- broadcast this tx, then click ok:\n\n${txhex}` );
                        var seller_sig = await dealership.signContractAsSeller();
                        var hd = document.createElement( "h2" );
                        hd.innerText = "send this info to the buyer";
                        $( '.procedure' ).append( hd );
                        var pg = document.createElement( "p" );
                        pg.innerText = JSON.stringify( {seller_sig} );
                        $( '.procedure' ).append( pg );
                        setNostrNote( encrypt( privKey, event.pubkey, JSON.stringify( {type: "more_info_for_buyer", msg: {seller_sig}} ) ), event.pubkey, relay );
                        //return here for seller
                        $( 'h2' ).remove();
                        $( 'p' ).remove();
                        $( 'h2' ).remove();
                        $( 'p' ).remove();
                        var hd = document.createElement( "h2" );
                        hd.innerText = "you're done!";
                        $( '.procedure' ).append( hd );
                    }
                    if ( content[ "type" ] == "more_info_for_buyer" ) {
                        console.log('content:', content);
                        var more_info_for_buyer = content[ "msg" ];
                        $( 'h2' ).remove();
                        var seller_sig = more_info_for_buyer[ "seller_sig" ];
                        console.log( 'seller sig:', seller_sig );
                        var txhex = await dealership.useMultisigAsBuyer( seller_sig );
                        alert( `ok you're the buyer now -- broadcast this tx, then click ok:\n\n${txhex}` );
                        // $( 'h2' ).remove();
                        var hd = document.createElement( "h2" );
                        hd.innerText = "you're done!";
                        $( '.procedure' ).append( hd );
                        //return here for buyer
                    }
                }
                if ( kind !== 63582 || $_GET[ "user" ] != "buyer" ) return;
                console.log('content:', content);
                if ( $( 'button' ) ) $( 'button' ).remove();
                var btn = document.createElement( "button" );
                btn.classList.add( "buy_utxo" );
                btn.innerText = "buy 3000 sats for 4000 sats";
                btn.setAttribute( "data-pubkey", content );
                btn.setAttribute( "data-nostrpub", event.pubkey );
                btn.onclick = async e => {
                    var sellers_pubkey = ( e.target.getAttribute( "data-pubkey" ) );
                    await dealership.prepBuyer( sellers_pubkey );
                    $( 'h2' ).remove();
                    $( '.buy_utxo' ).style.display = "none";
                    var hd = document.createElement( "h2" );
                    hd.innerText = "ok send 4000 sats to this address:";
                    $( '.procedure' ).append( hd );
                    var pg = document.createElement( "p" );
                    pg.innerText = dealership.buyers_contract.contract.address;
                    console.log( 4000, dealership.buyers_contract.contract.address );
                    $( '.procedure' ).append( pg );
                    await dealership.waitSomeSeconds( 3 );
                    await dealership.loopTilAddressReceivesMoney( dealership.buyers_contract.contract.address, "testnet/" );
                    var txinfo = await dealership.addressReceivedMoneyInThisTx( dealership.buyers_contract.contract.address, "testnet/" );
                    // var txid = prompt( "enter the txid" );
                    // var vout = prompt( "and the vout" );
                    // vout = Number( vout );
                    // var txinfo = [txid, vout, 4000];
                    // var txinfo = ["ab".repeat( 32 ), 0, 4000];
                    dealership[ "buyer_txid" ] = txinfo[ 0 ];
                    dealership[ "buyer_vout" ] = txinfo[ 1 ];
                    var some_bitcoin_address = "mkHS9ne12qx9pS9VojpwU5xtRd4T7X7ZUt";
                    dealership[ "buyer_address" ] = some_bitcoin_address;
                    var buyers_contract = dealership.buyers_contract.contract;
                    $( 'h2' ).remove();
                    $( 'p' ).remove();
                    //return here for buyer
                    var hd = document.createElement( "h2" );
                    hd.innerText = "waiting for the seller's okay";
                    $( '.procedure' ).append( hd );
                    // var pg = document.createElement( "p" );
                    // pg.innerText = JSON.stringify( {buyers_address: some_bitcoin_address, buyers_contract} );
                    // $( '.procedure' ).append( pg );
                    // var btn2 = document.createElement( "button" );
                    // btn2.classList.add( "info_sent" );
                    // btn2.innerText = "click when the info is sent";
                    var recipient = $( 'button' ).getAttribute( "data-nostrpub" );
                    setNostrNote( encrypt( privKey, recipient, JSON.stringify( {type: "accept", msg: {buyers_address: some_bitcoin_address, buyers_contract}} ) ), recipient, relay );
                    sessionStorage[ "info_for_seller" ] = JSON.stringify( {buyers_address: some_bitcoin_address, buyers_contract} );
                }
                $( '.procedure' ).append( btn );
            });

            socket.addEventListener('open', async function( e ) {
                console.log( "connected to " + relay );
                var subId   = bitcoinjs.ECPair.makeRandom().privateKey.toString( "hex" ).substring( 0, 16 );
                var filter  = { "#p": [ pubKey ] }
                var filter2  = { kinds: [ 63582 ], limit: 1 }
                var filter3  = { kinds: [ 63582 ], since: Math.floor( Date.now() / 1000 ) }
                var subscription = [ "REQ", subId, filter, filter2, filter3 ];
                console.log('Subscription:', subscription);
                socket.send(JSON.stringify( subscription ));
            });
            async function getSignedEvent(event, privateKey) {
                var eventData = JSON.stringify([
                    0,                  // Reserved for future use
                    event['pubkey'],        // The sender's public key
                    event['created_at'],    // Unix timestamp
                    event['kind'],      // Message “kind” or type
                    event['tags'],      // Tags identify replies/recipients
                    event['content']        // Your note contents
                ])
                event.id  = sha256( eventData ).toString( 'hex' );
                event.sig = await schnorr.sign( event.id, privateKey );
                return event;
            }
            function hexToBytes( hex ) {
                return Uint8Array.from( hex.match( /.{1,2}/g ).map( ( byte ) => parseInt( byte, 16 ) ) );
            }

            function bytesToHex( bytes ) {
                return bytes.reduce( ( str, byte ) => str + byte.toString( 16 ).padStart( 2, '0' ), '' );
            }
            function base64ToHex( str ) {
                var raw = atob( str );
                var result = '';
                var i; for ( i=0; i<raw.length; i++ ) {
                    var hex = raw.charCodeAt( i ).toString( 16 );
                    result += ( hex.length === 2 ? hex : '0' + hex );
                }
                return result;
            }
            function encrypt( privkey, pubkey, text ) {
                var key = nobleSecp256k1.getSharedSecret( privkey, '02' + pubkey, true ).substring( 2 );
                var iv = window.crypto.getRandomValues(new Uint8Array(16));
                var cipher = browserifyCipher.createCipheriv( 'aes-256-cbc', hexToBytes( key ), iv );
                var encryptedMessage = cipher.update(text,"utf8","base64");
                emsg = encryptedMessage + cipher.final( "base64" );
                var uint8View = new Uint8Array( iv.buffer );
                var decoder = new TextDecoder();
                return emsg + "?iv=" + btoa( String.fromCharCode.apply( null, uint8View ) );
            }
            function decrypt( privkey, pubkey, ciphertext ) {
                var [ emsg, iv ] = ciphertext.split( "?iv=" );
                var key = nobleSecp256k1.getSharedSecret( privkey, '02' + pubkey, true ).substring( 2 );
                var decipher = browserifyCipher.createDecipheriv(
                    'aes-256-cbc',
                    hexToBytes( key ),
                    hexToBytes( base64ToHex( iv ) )
                );
                var decryptedMessage = decipher.update( emsg, "base64" );
                dmsg = decryptedMessage + decipher.final( "utf8" );
                return dmsg;
            }
            var setNostrNote = async ( note, recipient, relay ) => {
                var event = {
                    "content": note,
                    "created_at": Math.floor( Date.now() / 1000 ),
                    "kind": recipient ? 4 : 63582,
                    "tags": recipient ? [ [ "p", recipient ] ] : [],
                    "pubkey": pubKey
                }
                var signedEvent = await getSignedEvent( event, privKey );
                var mysocket = new WebSocket( relay );
                mysocket.addEventListener( "open", () => mysocket.send( JSON.stringify( ["EVENT", signedEvent ] ) ) );
            }
        </script>
        <script>
            var dealership = {}
            dealership[ "hexToBytes" ] = hex => Uint8Array.from( hex.match( /.{1,2}/g ).map( ( byte ) => parseInt( byte, 16 ) ) );
            dealership[ "bytesToHex" ] = bytes => bytes.reduce( ( str, byte ) => str + byte.toString( 16 ).padStart( 2, "0" ), "" );
            dealership[ "sha256" ] = s => {
                if ( typeof s == "string" ) s = new TextEncoder().encode( s );
                return crypto.subtle.digest( 'SHA-256', s ).then( hashBuffer => {
                    var hashArray = Array.from( new Uint8Array( hashBuffer ) );
                    var hashHex = hashArray
                        .map( bytes => bytes.toString( 16 ).padStart( 2, '0' ) )
                        .join( '' );
                    return hashHex;
                });
            }
            dealership[ "getPrivateKey" ] = () => {
                return dealership.bytesToHex( nobleSecp256k1.utils.randomPrivateKey() );
            }
            dealership[ "getPublicKey" ] = privkey => {
                return nobleSecp256k1.getPublicKey( privkey, true ).substring( 2 );
            }
            dealership[ "waitSomeSeconds" ] = num => {
                var num = num.toString() + "000";
                num = Number( num );
                return new Promise( resolve => setTimeout( resolve, num ) );
            }
            dealership[ "getData" ] = async url => {
                return new Promise( async function( resolve, reject ) {
                    function inner_get( url ) {
                        var xhttp = new XMLHttpRequest();
                        xhttp.open( "GET", url, true );
                        xhttp.send();
                        return xhttp;
                    }
                    var data = inner_get( url );
                    data.onerror = function( e ) {
                        resolve( "error" );
                    }
                    async function isResponseReady() {
                        return new Promise( function( resolve2, reject ) {
                            if ( !data.responseText || data.readyState != 4 ) {
                                setTimeout( async function() {
                                    var msg = await isResponseReady();
                                    resolve2( msg );
                                }, 1 );
                            } else {
                                resolve2( data.responseText );
                            }
                        });
                    }
                    var returnable = await isResponseReady();
                    resolve( returnable );
                });
            }
            dealership[ "postData" ] = async (url, json, content_type = "", apikey = "") => {
                var rtext = "";
                function inner_post( url, json, content_type = "", apikey = "" ) {
                    var xhttp = new XMLHttpRequest();
                    xhttp.open( "POST", url, true );
                    if ( content_type ) {
                        xhttp.setRequestHeader( `Content-Type`, content_type );
                    }
                    if ( apikey ) {
                        xhttp.setRequestHeader( `X-Api-Key`, apikey );
                    }
                    xhttp.send( json );
                    return xhttp;
                }
                var data = inner_post( url, json, content_type, apikey );
                data.onerror = function( e ) {
                    rtext = "error";
                }
                async function isResponseReady() {
                    return new Promise( function( resolve, reject ) {
                        if ( rtext == "error" ) {
                            resolve( rtext );
                        }
                        if ( !data.responseText || data.readyState != 4 ) {
                            setTimeout( async function() {
                                var msg = await isResponseReady();
                                resolve( msg );
                            }, 50 );
                        } else {
                            resolve( data.responseText );
                        }
                    });
                }
                var returnable = await isResponseReady();
                return returnable;
            }
            dealership[ "pushBTCpmt" ] = async( rawtx, network ) => {
                var txid = await postData( "https://mempool.space/" + network + "api/tx", rawtx );
                return txid;
            }
            dealership[ "addressReceivedMoneyInThisTx" ] = async (address, network) => {
                let txid;
                let vout;
                let amt;
                let nonjson = await dealership.getData("https://mempool.space/" + network + "api/address/" + address + "/txs");
                let json = JSON.parse(nonjson);
                json.forEach(function (tx) {
                    tx["vout"].forEach(function (output, index) {
                        if (output["scriptpubkey_address"] == address) {
                            txid = tx["txid"];
                            vout = index;
                            amt = output["value"];
                        }
                    });
                });
                return [txid, vout, amt];
            }
            dealership[ "loopTilAddressReceivesMoney" ] = async (address, network) => {
                let itReceivedMoney = false;
                async function isDataSetYet(data_i_seek) {
                    return new Promise(function (resolve, reject) {
                        if (!data_i_seek) {
                            setTimeout(async function () {
                                console.log("waiting for address to receive money...");
                                try {
                                    itReceivedMoney = await dealership.addressOnceHadMoney(address, network);
                                }catch(e){ }
                                let msg = await isDataSetYet(itReceivedMoney);
                                resolve(msg);
                            }, 2000);
                        } else {
                            resolve(data_i_seek);
                        }
                    });
                }

                async function getTimeoutData() {
                    let data_i_seek = await isDataSetYet(itReceivedMoney);
                    return data_i_seek;
                }

                let returnable = await getTimeoutData();
                return returnable;
            }
            dealership[ "addressOnceHadMoney" ] = async (address, network) => {
                var nonjson = await dealership.getData( "https://mempool.space/" + network + "api/address/" + address );
                var json = JSON.parse( nonjson );
                if ( json[ "chain_stats" ][ "tx_count" ] > 0 || json[ "mempool_stats" ][ "tx_count" ] > 0 ) {
                    return true;
                }
                return false;
            }
            dealership[ "makeContract" ] = async (pubkey2, pubkey1, privkey2, hash, i_am_seller) => {
                var timelock = 10;
                var preimage = dealership.bytesToHex(nobleSecp256k1.utils.randomPrivateKey());
                if ( !hash ) {
                    var privkey1 = dealership.bytesToHex(nobleSecp256k1.utils.randomPrivateKey());
                    var pubkey1 = nobleSecp256k1.getPublicKey( privkey1, true ).substring( 2 );
                    var hash = await dealership.sha256( dealership.hexToBytes( preimage ) );
                    var contract = await dealership.getContract( pubkey1, pubkey2, timelock, hash );
                } else {
                    timelock = timelock - 5;
                    var contract = await dealership.getContract( pubkey2, pubkey1, timelock, hash );
                }
                if ( !i_am_seller ) return {privkey1, preimage, contract}
                return {privkey2, contract}
            }
            dealership[ "getContract" ] = async (pubkey1, pubkey2, timelock, hash) => {
                var scripts = [
                    [
                        timelock,
                        'OP_CHECKSEQUENCEVERIFY',
                        'OP_DROP',
                        pubkey1,
                        'OP_CHECKSIG'
                    ],
                    [
                        'OP_SHA256',
                        hash,
                        'OP_EQUALVERIFY',
                        pubkey2,
                        'OP_CHECKSIG'
                    ],
                    [
                        'OP_0',
                        pubkey1,
                        'OP_CHECKSIGADD',
                        pubkey2,
                        'OP_CHECKSIGADD',
                        'OP_2',
                        'OP_EQUAL'
                    ]
                ];
                var tree = scripts.map(s => tapscript.Tap.encodeScript(s));
                var index  = 0; //alternatives: 1 or 2 -- whichever script you want to redeem using
                var script = scripts[index];
                var target = tapscript.Tap.encodeScript(script);
                var pubkey = "ab".repeat( 32 );
                var [ tpubkey ] = tapscript.Tap.getPubKey(pubkey, { tree, target });
                var address = tapscript.Address.p2tr.fromPubKey(tpubkey, 'testnet');
                return {address, pubkey1, pubkey2, timelock, hash};
            }
            dealership[ "signContract" ] = (privkey, pubkey1, pubkey2, destino, from_amount, to_amount, timelock, hash, txid, vout) => {
                index = 2;
                var scripts = [
                    [
                        timelock,
                        'OP_CHECKSEQUENCEVERIFY',
                        'OP_DROP',
                        pubkey1,
                        'OP_CHECKSIG'
                    ],
                    [
                        'OP_SHA256',
                        hash,
                        'OP_EQUALVERIFY',
                        pubkey2,
                        'OP_CHECKSIG'
                    ],
                    [
                        'OP_0',
                        pubkey1,
                        'OP_CHECKSIGADD',
                        pubkey2,
                        'OP_CHECKSIGADD',
                        'OP_2',
                        'OP_EQUAL'
                    ]
                ];
                var tree = scripts.map(s => tapscript.Tap.encodeScript(s));
                var script = scripts[index];
                var target = tapscript.Tap.encodeScript(script);
                var pubkey = "ab".repeat( 32 );
                console.log( index, scripts[ index ], pubkey, tree, target, scripts[ 0 ] );
                var [ tpubkey, cblock ] = tapscript.Tap.getPubKey(pubkey, { tree, target });
                var txdata = tapscript.Tx.create({
                  vin: [{
                    txid: txid,
                    vout: vout,
                    prevout: {value: from_amount, scriptPubKey: ["OP_1", tpubkey]},
                    sequence: 0xffffffff,
                    witness: []
                  }],
                  vout: [{
                    value: to_amount,
                    scriptPubKey: tapscript.Address.toScriptPubKey(destino)
                  }],
                });
                var vin_to_sign = 0;
                var sighash = tapscript.Signer.taproot.hash( txdata, vin_to_sign, {extension: target, pubkey: nobleSecp256k1.getPublicKey( privkey, true ).substring( 2 )} ).hex;
                var sig1 = tapscript.Signer.taproot.sign(privkey, txdata, vin_to_sign, { extension: target });
                console.log( "txdata:", txdata );
                console.log( "sig:", sig1.hex, "sighash:", sighash, "pubkey:", nobleSecp256k1.getPublicKey( privkey, true ).substring( 2 ) );
                return sig1.hex;
            }
            dealership[ "settleContract" ] = async (privkey, pubkey1, pubkey2, index, destino, from_amount, to_amount, timelock, sig2, preimage, hash, txid, vout, i_am_buyer, set_sequence_as_seller, disable_sequence) => {
                var scripts = [
                    [
                        timelock,
                        'OP_CHECKSEQUENCEVERIFY',
                        'OP_DROP',
                        pubkey1,
                        'OP_CHECKSIG'
                    ],
                    [
                        'OP_SHA256',
                        hash,
                        'OP_EQUALVERIFY',
                        pubkey2,
                        'OP_CHECKSIG'
                    ],
                    [
                        'OP_0',
                        pubkey1,
                        'OP_CHECKSIGADD',
                        pubkey2,
                        'OP_CHECKSIGADD',
                        'OP_2',
                        'OP_EQUAL'
                    ]
                ];
                var tree = scripts.map(s => tapscript.Tap.encodeScript(s));
                var script = scripts[index];
                var target = tapscript.Tap.encodeScript(script);
                var pubkey = "ab".repeat( 32 );
                console.log( index, scripts[ index ], pubkey, tree, target, scripts[ 0 ] );
                var [ tpubkey, cblock ] = tapscript.Tap.getPubKey(pubkey, { tree, target });
                var txdata = tapscript.Tx.create({
                  vin: [{
                    txid: txid,
                    vout: vout,
                    prevout: {value: from_amount, scriptPubKey: ["OP_1", tpubkey]},
                    sequence: ( ( i_am_buyer || set_sequence_as_seller ) && !disable_sequence ) ? ( timelock ).toString( 16 ).padStart( 8, "0" ) : 0xffffffff,
                    witness: []
                  }],
                  vout: [{
                    value: to_amount,
                    scriptPubKey: tapscript.Address.toScriptPubKey(destino)
                  }],
                });
                var vin_to_sign = 0;
                // console.log( txdata, vin_to_sign, target, nobleSecp256k1.getPublicKey( privkey, true ).substring( 2 ) );
                var sighash = tapscript.Signer.taproot.hash( txdata, vin_to_sign, {extension: target, pubkey: nobleSecp256k1.getPublicKey( privkey, true ).substring( 2 )} ).hex;
                var sig1 = tapscript.Signer.taproot.sign(privkey, txdata, vin_to_sign, { extension: target });
                console.log( "txdata:", txdata );
                console.log( "sig:", sig1.hex, "sighash:", sighash, "pubkey:", nobleSecp256k1.getPublicKey( privkey, true ).substring( 2 ) );
                var sig_is_good = await nobleSecp256k1.schnorr.verify( sig1.hex, sighash, nobleSecp256k1.getPublicKey( privkey, true ).substring( 2 ) );
                // console.log( "sig is good, right?", sig_is_good, sig1.hex, sighash, nobleSecp256k1.getPublicKey( privkey, true ).substring( 2 ) );
                txdata.vin[0].witness = [ sig1, script, cblock ];
                if ( preimage ) txdata.vin[0].witness = [ sig1, preimage, script, cblock ];
                if ( sig2 ) txdata.vin[0].witness = [ sig1, sig2, script, cblock ];
                return tapscript.Tx.encode(txdata).hex;
            }
            dealership[ "buyers_contract" ] = {}
            dealership[ "sellers_contract" ] = {}
            dealership[ "buyer_txid" ] = null;
            dealership[ "buyer_vout" ] = null;
            dealership[ "seller_txid" ] = null;
            dealership[ "seller_vout" ] = null;
            dealership[ "seller_address" ] = null;
            dealership[ "buyer_address" ] = null;
            dealership[ "prepBuyer" ] = async pubkey2 => {
                dealership[ "buyers_contract" ] = await dealership.makeContract( pubkey2 );
                return true;
            }
            dealership[ "refundBuyer" ] = async () => {
                var privkey = dealership[ "buyers_contract" ][ "privkey1" ];
                var pubkey1 = dealership[ "buyers_contract" ][ "contract" ][ "pubkey1" ];
                var pubkey2 = dealership[ "buyers_contract" ][ "contract" ][ "pubkey2" ];
                var index = 0;
                var destino = dealership[ "buyer_address" ];
                var from_amount = 4_000;
                var to_amount = from_amount - 500;
                var timelock = dealership[ "buyers_contract" ][ "contract" ][ "timelock" ];
                var sig2 = null;
                var preimage = null;
                var hash = dealership[ "buyers_contract" ][ "contract" ][ "hash" ];
                var txid = dealership[ "buyer_txid" ];
                var vout = dealership[ "buyer_vout" ];
                // var txid = "a54b11cca36c1bb64704a9628499df008db7d8ec325a5eb1f9e4ab00c4dcc43a";
                // var vout = 1;
                var i_am_buyer = true;
                var txhex = await dealership.settleContract(privkey, pubkey1, pubkey2, index, destino, from_amount, to_amount, timelock, sig2, preimage, hash, txid, vout, i_am_buyer);
                return txhex;
                // remember not to broadcast your tx til the timelock expires
            }
            dealership[ "usePreimageAsSeller" ] = async privkey => {
                // var privkey = privkey2;
                var pubkey1 = dealership[ "buyers_contract" ][ "contract" ][ "pubkey1" ];
                var pubkey2 = dealership[ "buyers_contract" ][ "contract" ][ "pubkey2" ];
                var index = 1;
                var destino = dealership[ "seller_address" ];
                var from_amount = 4_000;
                var to_amount = from_amount - 500;
                var timelock = dealership[ "buyers_contract" ][ "contract" ][ "timelock" ];
                var sig2 = null;
                var preimage = dealership[ "buyers_contract" ][ "preimage" ];
                var hash = dealership[ "buyers_contract" ][ "contract" ][ "hash" ];
                var txid = dealership[ "buyer_txid" ];
                var vout = dealership[ "buyer_vout" ];
                // var txid = "22be2c4c41cd659ad41d3d474c405ee65be284245dcd170884dbd3b28512f88f";
                // var vout = 1;
                var i_am_buyer = false;
                var txhex = await dealership.settleContract(privkey, pubkey1, pubkey2, index, destino, from_amount, to_amount, timelock, sig2, preimage, hash, txid, vout, i_am_buyer);
                return txhex;
            }
            dealership[ "signContractAsBuyer" ] = () => {
                var privkey = dealership[ "buyers_contract" ][ "privkey1" ];
                var pubkey1 = dealership[ "buyers_contract" ][ "contract" ][ "pubkey1" ];
                var pubkey2 = dealership[ "buyers_contract" ][ "contract" ][ "pubkey2" ];
                var index = 2;
                var destino = dealership[ "seller_address" ];
                var from_amount = 4_000;
                var to_amount = from_amount - 500;
                var timelock = dealership[ "buyers_contract" ][ "contract" ][ "timelock" ];
                var hash = dealership[ "buyers_contract" ][ "contract" ][ "hash" ];
                var txid = dealership[ "buyer_txid" ];
                var vout = dealership[ "buyer_vout" ];
                // var txid = "9f7482339a9cd2735fbd94bed214e80a1667b89ba92cde7bf8b2a9d2b06ae5b1";
                // var vout = 1;
                return dealership.signContract(privkey, pubkey1, pubkey2, destino, from_amount, to_amount, timelock, hash, txid, vout);
            }
            dealership[ "useMultisigAsSeller" ] = async ( privkey, sig2 ) => {
                // var privkey = privkey2;
                var pubkey1 = dealership[ "buyers_contract" ][ "contract" ][ "pubkey1" ];
                var pubkey2 = dealership[ "buyers_contract" ][ "contract" ][ "pubkey2" ];
                var index = 2;
                var destino = dealership[ "seller_address" ];
                var from_amount = 4_000;
                var to_amount = from_amount - 500;
                var timelock = dealership[ "buyers_contract" ][ "contract" ][ "timelock" ];
                var preimage = null;
                var hash = dealership[ "buyers_contract" ][ "contract" ][ "hash" ];
                var txid = dealership[ "buyer_txid" ];
                var vout = dealership[ "buyer_vout" ];
                // var txid = "9f7482339a9cd2735fbd94bed214e80a1667b89ba92cde7bf8b2a9d2b06ae5b1";
                // var vout = 1;
                // var sig2 = dealership.signContract(contract[ "privkey1" ], pubkey1, pubkey2, destino, from_amount, to_amount, timelock, hash, txid, vout);
                var i_am_buyer = false;
                var txhex = await dealership.settleContract(privkey, pubkey1, pubkey2, index, destino, from_amount, to_amount, timelock, sig2, preimage, hash, txid, vout, i_am_buyer);
                return txhex;
            }
            dealership[ "prepSeller" ] = async privkey2 => {
                var pubkey1 = dealership[ "buyers_contract" ][ "contract" ][ "pubkey1" ];
                var pubkey2 = dealership[ "buyers_contract" ][ "contract" ][ "pubkey2" ];
                var hash = dealership[ "buyers_contract" ][ "contract" ][ "hash" ];
                dealership[ "sellers_contract" ] = await dealership.makeContract( pubkey2, pubkey1, privkey2, hash, true );
                return true;
            }
            dealership[ "refundSeller" ] = async () => {
                var privkey = dealership[ "sellers_contract" ][ "privkey2" ];
                var pubkey1 = dealership[ "sellers_contract" ][ "contract" ][ "pubkey1" ];
                var pubkey2 = dealership[ "sellers_contract" ][ "contract" ][ "pubkey2" ];
                var index = 0;
                var destino = dealership[ "seller_address" ];
                var from_amount = 3_000;
                var to_amount = from_amount - 500;
                var timelock = dealership[ "sellers_contract" ][ "contract" ][ "timelock" ];
                var sig2 = null;
                var preimage = null;
                var hash = dealership[ "sellers_contract" ][ "contract" ][ "hash" ];
                var txid = dealership[ "seller_txid" ];
                var vout = dealership[ "seller_vout" ];
                // var txid = "e766011e7249528ef5adcc433c8d1d60d698e834b038c0d41d3191168377c9be";
                // var vout = 1;
                var i_am_buyer = false;
                var txhex = await dealership.settleContract(privkey, pubkey1, pubkey2, index, destino, from_amount, to_amount, timelock, sig2, preimage, hash, txid, vout, i_am_buyer, true);
                return txhex;
                // remember not to broadcast your tx til the timelock expires
            }
            dealership[ "usePreimageAsBuyer" ] = async () => {
                var privkey = contract[ "privkey1" ];
                //remember that the pubkeys are reversed in the next two lines
                var pubkey2 = dealership[ "buyers_contract" ][ "contract" ][ "pubkey1" ];
                var pubkey1 = dealership[ "buyers_contract" ][ "contract" ][ "pubkey2" ];
                var index = 1;
                var destino = dealership[ "buyer_address" ];
                var from_amount = 3_000;
                var to_amount = from_amount - 500;
                var timelock = dealership[ "sellers_contract" ][ "contract" ][ "timelock" ];
                var sig2 = null;
                var preimage = dealership[ "buyers_contract" ][ "preimage" ];
                var hash = dealership[ "buyers_contract" ][ "contract" ][ "hash" ];
                var txid = dealership[ "seller_txid" ];
                var vout = dealership[ "seller_vout" ];
                // var txid = "40e535afb7b0cc9dcef4c65ffae3e8a5ba1de63849c7bab3e829dbf62d88e50f";
                // var vout = 1;
                var i_am_buyer = true;
                var txhex = await dealership.settleContract(privkey, pubkey1, pubkey2, index, destino, from_amount, to_amount, timelock, sig2, preimage, hash, txid, vout, i_am_buyer, null, true);
                return txhex;
            }
            dealership[ "signContractAsSeller" ] = () => {
                var privkey = dealership[ "sellers_contract" ][ "privkey2" ];
                var pubkey1 = dealership[ "sellers_contract" ][ "contract" ][ "pubkey1" ];
                var pubkey2 = dealership[ "sellers_contract" ][ "contract" ][ "pubkey2" ];
                var index = 2;
                var destino = dealership[ "buyer_address" ];
                var from_amount = 3_000;
                var to_amount = from_amount - 500;
                var timelock = dealership[ "sellers_contract" ][ "contract" ][ "timelock" ];
                var hash = dealership[ "sellers_contract" ][ "contract" ][ "hash" ];
                var txid = dealership[ "seller_txid" ];
                var vout = dealership[ "seller_vout" ];
                // var txid = "9f7482339a9cd2735fbd94bed214e80a1667b89ba92cde7bf8b2a9d2b06ae5b1";
                // var vout = 1;
                return dealership.signContract(privkey, pubkey1, pubkey2, destino, from_amount, to_amount, timelock, hash, txid, vout);
            }
            dealership[ "useMultisigAsBuyer" ] = async sig2 => {
                var privkey = dealership[ "buyers_contract" ][ "privkey1" ];
                //remember that the pubkeys are reversed in the next two lines
                var pubkey2 = dealership[ "buyers_contract" ][ "contract" ][ "pubkey1" ];
                var pubkey1 = dealership[ "buyers_contract" ][ "contract" ][ "pubkey2" ];
                var index = 2;
                var destino = dealership[ "buyer_address" ];
                var from_amount = 3_000;
                var to_amount = from_amount - 500;
                var timelock = dealership[ "sellers_contract" ][ "contract" ][ "timelock" ];
                var preimage = null;
                var hash = dealership[ "buyers_contract" ][ "contract" ][ "hash" ];
                var txid = dealership[ "seller_txid" ];
                var vout = dealership[ "seller_vout" ];
                // var txid = "072d8f21ebe6d74507331f843848e188eedbc7902f08ce18f50fc1e3b639b95a";
                // var vout = 1;
                // var sig2 = dealership.signContract(new_contract[ "privkey2" ], pubkey1, pubkey2, destino, from_amount, to_amount, timelock, hash, txid, vout);
                var i_am_buyer = true;
                var txhex = await dealership.settleContract(privkey, pubkey1, pubkey2, index, destino, from_amount, to_amount, timelock, sig2, preimage, hash, txid, vout, i_am_buyer, null, true);
                return txhex;
            }
        </script>
    </head>
    <body>
        <h1>Utxo Dealership</h1>
        <div class="procedure">
            <h2>You are the seller -- click the button below</h2>
            <button class="sell_utxo">Sell your new utxo</button>
        </div>
        <script>
            if ( $_GET[ "user" ] == "buyer" ) {
                $( 'h2' ).remove();
                $( '.sell_utxo' ).remove();
                var hd = document.createElement( "h2" );
                hd.innerText = "You are the buyer -- buy a new utxo";
                $( '.procedure' ).append( hd );
                var btn = document.createElement( "button" );
                btn.classList.add( "buy_utxo" );
                btn.innerText = "buy 3000 sats for 4000 sats";
            }
            if ( $( '.sell_utxo' ) ) $( '.sell_utxo' ).onclick = () => {
                $( 'h2' ).remove();
                $( '.sell_utxo' ).remove();
                var sellers_privkey = dealership.getPrivateKey();
                sessionStorage[ "sellers_privkey" ] = sellers_privkey;
                var sellers_pubkey = dealership.getPublicKey( sellers_privkey );
                setNostrNote( sellers_pubkey, null, relay );
                var hd = document.createElement( "h2" );
                hd.innerText = "waiting for someone to take your offer";
                $( '.procedure' ).append( hd );
            }
        </script>
        <script>
            //PROCEDURE

            //seller clicks "Sell your new utxo" and runs var sellers_privkey = dealership.getPrivateKey() and var sellers_pubkey = dealership.getPublicKey( sellers_privkey )
            //seller makes sellers_pubkey a data-pubkey="" attribute of each offer button
            //buyer gets sellers_pubkey when he selects an offer and calls dealership.prepBuyer( sellers_pubkey )
            //buyer sends 4_000 sats to dealership.buyers_contract.contract.address
            //buyer runs var txinfo = await dealership.addressReceivedMoneyInThisTx( dealership.buyers_contract.contract.address, "testnet/" )
            //buyer runs dealership[ "buyer_txid" ] = txinfo[ 0 ]
            //buyer runs dealership[ "buyer_vout" ] = txinfo[ 1 ]
            //buyer runs dealership[ "buyer_address" ] = some_bitcoin_address
            //buyer runs var buyers_contract = dealership.buyers_contract.contract
            //buyer sends the variables "buyers_contract" and "some_bitcoin_address" to seller
            //seller takes "buyers_contract" and "some_bitcoin_address" from buyer
            //seller runs var txinfo = await dealership.addressReceivedMoneyInThisTx( buyers_contract.address, "testnet/" )
            //seller checks if txinfo[ 2 ] == 4_000 and fails if not
            //seller runs dealership[ "buyer_txid" ] = txinfo[ 0 ]
            //seller runs dealership[ "buyer_vout" ] = txinfo[ 1 ]
            //seller runs dealership[ "buyer_address" ] = some_bitcoin_address
            //seller runs dealership.buyers_contract.contract = buyers_contract
            //seller calls dealership.prepSeller( sellers_privkey )
            //seller sends 3_000 sats to dealership.sellers_contract.contract.address
            //seller runs var txinfo = await dealership.addressReceivedMoneyInThisTx( dealership.sellers_contract.contract.address, "testnet/" )
            //seller runs dealership[ "seller_txid" ] = txinfo[ 0 ]
            //seller runs dealership[ "seller_vout" ] = txinfo[ 1 ]
            //seller runs dealership[ "seller_address" ] = another_bitcoin_address
            //seller runs var sellers_contract = dealership.sellers_contract.contract
            //seller sends the variables "sellers_contract" and another_bitcoin_address to buyer
            //buyer takes "sellers_contract" and another_bitcoin_address from seller
            //buyer runs var txinfo = await dealership.addressReceivedMoneyInThisTx( sellers_contract.address, "testnet/" )
            //seller checks if txinfo[ 2 ] == 3_000 and fails if not
            //if buyer fails he should run var txhex = await dealership.refundBuyer( destination ) and broadcast the tx after 10 blocks
            //buyer runs dealership[ "seller_txid" ] = txinfo[ 0 ]
            //buyer runs dealership[ "seller_vout" ] = txinfo[ 1 ]
            //buyer runs dealership[ "seller_address" ] = another_bitcoin_address
            //buyer runs dealership.sellers_contract.contract = sellers_contract
            //buyer runs var buyer_sig = await dealership.signContractAsBuyer()
            //buyer runs var buyer_preimage = dealership.buyers_contract.preimage
            //buyer sends buyer_sig and buyer_preimage to seller
            //seller checks if buyer_preimage hashes to dealership.sellers_contract.contract.hash and fails if not
            //if seller fails he should run var txhex = await dealership.refundSeller() and broadcast the tx after 5 blocks
            //seller runs var txhex = await dealership.useMultisigAsSeller( dealership.sellers_contract.privkey2, buyer_sig ) and broadcasts the tx immediately
            //seller runs var seller_sig = await dealership.signContractAsSeller()
            //seller sends seller_sig to buyer

            //buyer runs var txhex = await dealership.useMultisigAsBuyer( seller_sig ) and broadcasts the tx immediately
        </script>
        <script>
            //here is code for defining private keys and creating the buyer's htlc:
            // var privkey2 = dealership.bytesToHex(nobleSecp256k1.utils.randomPrivateKey());
            // var pubkey2 = nobleSecp256k1.getPublicKey( privkey2, true ).substring( 2 );
            // var contract = await dealership.makeContract( pubkey2 );

            //here is code for spending the money as the buyer:
            // var privkey = contract[ "privkey1" ];
            // var pubkey1 = contract[ "contract" ][ "pubkey1" ];
            // var pubkey2 = contract[ "contract" ][ "pubkey2" ];
            // var index = 0;
            // var destino = "mkHS9ne12qx9pS9VojpwU5xtRd4T7X7ZUt";
            // var from_amount = 50_000;
            // var to_amount = 49_500;
            // var timelock = contract[ "contract" ][ "timelock" ];
            // var sig2 = null;
            // var preimage = null;
            // var hash = contract[ "contract" ][ "hash" ];
            // var txid = "a54b11cca36c1bb64704a9628499df008db7d8ec325a5eb1f9e4ab00c4dcc43a";
            // var vout = 1;
            // var i_am_buyer = true;
            // dealership.settleContract(privkey, pubkey1, pubkey2, index, destino, from_amount, to_amount, timelock, sig2, preimage, hash, txid, vout, i_am_buyer);
            // // remember not to broadcast your tx til the timelock expires

            //here is code for spending the money as the seller (preimage path):
            // var privkey = privkey2;
            // var pubkey1 = contract[ "contract" ][ "pubkey1" ];
            // var pubkey2 = contract[ "contract" ][ "pubkey2" ];
            // var index = 1;
            // var destino = "mkHS9ne12qx9pS9VojpwU5xtRd4T7X7ZUt";
            // var from_amount = 50_000;
            // var to_amount = 49_500;
            // var timelock = contract[ "contract" ][ "timelock" ];
            // var sig2 = null;
            // var preimage = contract[ "preimage" ];
            // var hash = contract[ "contract" ][ "hash" ];
            // var txid = "22be2c4c41cd659ad41d3d474c405ee65be284245dcd170884dbd3b28512f88f";
            // var vout = 1;
            // var i_am_buyer = false;
            // dealership.settleContract(privkey, pubkey1, pubkey2, index, destino, from_amount, to_amount, timelock, sig2, preimage, hash, txid, vout, i_am_buyer);

            //here is code for spending the money as the seller (multisig path):
            // var privkey = privkey2;
            // var pubkey1 = contract[ "contract" ][ "pubkey1" ];
            // var pubkey2 = contract[ "contract" ][ "pubkey2" ];
            // var index = 2;
            // var destino = "mkHS9ne12qx9pS9VojpwU5xtRd4T7X7ZUt";
            // var from_amount = 50_000;
            // var to_amount = 49_500;
            // var timelock = contract[ "contract" ][ "timelock" ];
            // var preimage = null;
            // var hash = contract[ "contract" ][ "hash" ];
            // var txid = "9f7482339a9cd2735fbd94bed214e80a1667b89ba92cde7bf8b2a9d2b06ae5b1";
            // var vout = 1;
            // var sig2 = dealership.signContract(contract[ "privkey1" ], pubkey1, pubkey2, destino, from_amount, to_amount, timelock, hash, txid, vout);
            // var i_am_buyer = false;
            // dealership.settleContract(privkey, pubkey1, pubkey2, index, destino, from_amount, to_amount, timelock, sig2, preimage, hash, txid, vout, i_am_buyer);

            //here is code for creating the seller's htlc:
            // var pubkey1 = contract[ "contract" ][ "pubkey1" ];
            // var pubkey2 = contract[ "contract" ][ "pubkey2" ];
            // var hash = contract[ "contract" ][ "hash" ];
            // var new_contract = await dealership.makeContract( pubkey2, pubkey1, privkey2, hash, true );

            //here is code for spending the money as the seller:
            // var privkey = new_contract[ "privkey2" ];
            // var pubkey1 = new_contract[ "contract" ][ "pubkey1" ];
            // var pubkey2 = new_contract[ "contract" ][ "pubkey2" ];
            // var index = 0;
            // var destino = "mkHS9ne12qx9pS9VojpwU5xtRd4T7X7ZUt";
            // var from_amount = 50_000;
            // var to_amount = 49_500;
            // var timelock = new_contract[ "contract" ][ "timelock" ];
            // var sig2 = null;
            // var preimage = null;
            // var hash = new_contract[ "contract" ][ "hash" ];
            // var txid = "e766011e7249528ef5adcc433c8d1d60d698e834b038c0d41d3191168377c9be";
            // var vout = 1;
            // var i_am_buyer = false;
            // dealership.settleContract(privkey, pubkey1, pubkey2, index, destino, from_amount, to_amount, timelock, sig2, preimage, hash, txid, vout, i_am_buyer, true);
            // // remember not to broadcast your tx til the timelock expires

            //here is code for spending the money as the buyer (preimage path):
            // var privkey = contract[ "privkey1" ];
            // //remember that the pubkeys are reversed in the next two lines
            // var pubkey2 = contract[ "contract" ][ "pubkey1" ];
            // var pubkey1 = contract[ "contract" ][ "pubkey2" ];
            // var index = 1;
            // var destino = "mkHS9ne12qx9pS9VojpwU5xtRd4T7X7ZUt";
            // var from_amount = 50_000;
            // var to_amount = 49_500;
            // var timelock = new_contract[ "contract" ][ "timelock" ];
            // var sig2 = null;
            // var preimage = contract[ "preimage" ];
            // var hash = contract[ "contract" ][ "hash" ];
            // var txid = "40e535afb7b0cc9dcef4c65ffae3e8a5ba1de63849c7bab3e829dbf62d88e50f";
            // var vout = 1;
            // var i_am_buyer = true;
            // dealership.settleContract(privkey, pubkey1, pubkey2, index, destino, from_amount, to_amount, timelock, sig2, preimage, hash, txid, vout, i_am_buyer, null, true);

            //here is code for spending the money as the buyer (multisig path):
            // var privkey = contract[ "privkey1" ];
            // //remember that the pubkeys are reversed in the next two lines
            // var pubkey2 = contract[ "contract" ][ "pubkey1" ];
            // var pubkey1 = contract[ "contract" ][ "pubkey2" ];
            // var index = 2;
            // var destino = "mkHS9ne12qx9pS9VojpwU5xtRd4T7X7ZUt";
            // var from_amount = 50_000;
            // var to_amount = 49_500;
            // var timelock = new_contract[ "contract" ][ "timelock" ];
            // var preimage = null;
            // var hash = contract[ "contract" ][ "hash" ];
            // var txid = "072d8f21ebe6d74507331f843848e188eedbc7902f08ce18f50fc1e3b639b95a";
            // var vout = 1;
            // var sig2 = dealership.signContract(new_contract[ "privkey2" ], pubkey1, pubkey2, destino, from_amount, to_amount, timelock, hash, txid, vout);
            // var i_am_buyer = true;
            // dealership.settleContract(privkey, pubkey1, pubkey2, index, destino, from_amount, to_amount, timelock, sig2, preimage, hash, txid, vout, i_am_buyer, null, true);
        </script>
        <script>
            //first the buyer creates an htlc and deposits his coins inside
            //the buyer should be able to take the coins after the timelock
            //but the seller should be able to take them with the preimage
            //next the seller creates an htlc and deposits a coinbase inside
            //the seller should be able to take the coins after the timelock
            //but the buyer should be able to take them with the preimage
            //the buyer's timelock should be longer than the seller's otherwise
            //the buyer could wait til his own timelock expires, then sweep
            //the funds from his own htlc using the timelock path, then
            //sweep the funds from the seller's htlc using the preimage before
            //the seller's timelock expires, thus taking the seller's money
            //without the seller being able to reimburse himself
            //also both htlcs should use the same hash which the buyer knows
            //when the coinbase matures the buyer should disclose the preimage
            //to the seller
            //then the seller should send the buyer a sig so he can withdraw
            //from the seller's htlc using the multisig path
            //then the buyer should send the seller a sig so he can withdraw
            //from the buyer's htlc using the multisig path
            //TESTING
            //to test the script I need to specify privkeys for the buyer
            //and the seller, then send money to the buyer's htlc [done]
            //then I should see if I can spend the money as the buyer using
            //the timelock path (before and after it expires) [done]
            //then I should see if I can spend the money as the seller using
            //the preimage path [done]
            //then I should see if I can spend the money as the seller using
            //the multisig path [done]
            //then I should create the seller's htlc and send a coinbase to it [done]
            //then I should see if I can spend the money as the seller using
            //the timelock path (before and after it expires -- remember that it
            //has a shorter timelock) [done]
            //then I should see if I can spend the money as the buyer using
            //the preimage path (before and after the coinbase matures) [done]
            //then I should see if I can spend the money as the buyer using
            //the mutlisig path (before and after the coinbase matures) [done]
        </script>
    </body>
</html>
