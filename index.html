<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, user-scalable=no">
        <script src="https://bitcoincore.tech/apps/bitcoinjs-ui/lib/bitcoinjs-lib.js"></script>
        <script src="https://bundle.run/browserify-cipher@1.0.1"></script>
        <script src="https://unpkg.com/@cmdcode/tapscript@1.4.0"></script>
        <script src="https://bundle.run/noble-secp256k1@1.2.14"></script>
        <script src="https://bundle.run/buffer@6.0.3"></script>
        <script>var Buffer = buffer.Buffer;</script>
        <style>
            * {
                box-sizing: border-box;
                font-size: 1.15rem;
                font-family: Arial, sans-serif;
            }
            html {
                max-width: 70ch;
                padding: 3rem 1rem;
                margin: auto;
                line-height: 1.25;
            }
            h1 {
                font-size: 2rem;
            }
            h2 {
                font-size: 1.5rem;
            }
            input {
                line-height: 1.25;
                width: 100%;
                height: 1.8rem;
                font-size: 1.15rem;
                border: 1px solid grey;
            }
            @media screen and (max-width: 600px) {
            }
        </style>
        <script>
            var $ = document.querySelector.bind( document );
            var $$ = document.querySelectorAll.bind( document );
            var url_params = new URLSearchParams( window.location.search );
            var url_keys = url_params.keys();
            var $_GET = {}
            for ( var key of url_keys ) $_GET[ key ] = url_params.get( key );
        </script>
        <script>
            var { getSharedSecret, schnorr, utils } = nobleSecp256k1;
            var crypto  = window.crypto;
            var sha256  = bitcoinjs.crypto.sha256;
            var keypair = bitcoinjs.ECPair.makeRandom();
            var privKey = keypair.privateKey.toString( "hex" );
            var pubKey  = keypair.publicKey.toString( "hex" );
            pubKey      = pubKey.substring( 2 );
            console.log( pubKey );
            var relay = "wss://nostrue.com";
            var socket = new WebSocket( relay );
            socket.addEventListener('message', async function( message ) {
                var [ type, subId, event ] = JSON.parse( message.data );
                var { kind, content } = event || {}
                if (!event || event === true) return;
                if (kind === 4) {
                    content = await decrypt(privKey, event.pubkey, content);
                    content = JSON.parse( content );
                    if ( content[ "type" ] == "accept" ) {
                        var info_for_seller = content[ "msg" ];
                        var offer = info_for_seller[ "offer" ];
                        var buyers_contract = info_for_seller[ "buyers_contract" ];
                        var buyers_address = info_for_seller[ "buyers_address" ];
                        var buyers_contract = buyers_contract;
                        if ( $_GET[ "network" ] == "regtest" ) {
                            var txid = prompt( "enter the txid you just entered" );
                            var vout = prompt( "and the vout" );
                            vout = Number( vout );
                            var txinfo = [txid, vout, 4000];
                            // var txinfo = ["ab".repeat( 32 ), 0, 4000];
                        } else {
                            //change to testnet/
                            var txinfo = await dealership.addressReceivedMoneyInThisTx( buyers_contract.address, "" )
                        }
                        if ( txinfo[ 2 ] != 4_000 ) return;
                        dealership[ "offers" ][ offer ][ "buyer_txid" ] = txinfo[ 0 ];
                        dealership[ "offers" ][ offer ][ "buyer_vout" ] = txinfo[ 1 ];
                        dealership[ "offers" ][ offer ][ "buyer_address" ] = buyers_address;
                        dealership[ "offers" ][ offer ].buyers_contract.contract = buyers_contract;
                        var sellers_privkey = dealership[ "offers" ][ offer ][ "sellers_privkey" ]
                        var second_sellers_privkey = dealership[ "offers" ][ offer ][ "second_sellers_privkey" ]
                        await dealership.prepSeller( sellers_privkey, second_sellers_privkey, offer );
                        $( 'h2' ).remove();
                        var hd = document.createElement( "h2" );
                        hd.innerText = "ok you're the seller now, send 3000 sats to this address:";
                        $( '.procedure' ).append( hd );
                        var pg = document.createElement( "p" );
                        console.log( 3000, dealership[ "offers" ][ offer ].sellers_contract.contract.address );
                        pg.innerText = dealership[ "offers" ][ offer ].sellers_contract.contract.address;
                        $( '.procedure' ).append( pg );
                        await dealership.waitSomeSeconds( 3 );
                        if ( $_GET[ "network" ] == "regtest" ) {
                            var txid = prompt( "enter the txid" );
                            var vout = prompt( "and the vout" );
                            vout = Number( vout );
                            var txinfo = [txid, vout, 3000];
                            // var txinfo = ["ab".repeat( 32 ), 0, 3000];
                        } else {
                            //change to testnet/
                            await dealership.loopTilAddressReceivesMoney( dealership[ "offers" ][ offer ].sellers_contract.contract.address, "" );
                            //change to testnet/
                            var txinfo = await dealership.addressReceivedMoneyInThisTx( dealership[ "offers" ][ offer ].sellers_contract.contract.address, "" );
                        }
                        dealership[ "offers" ][ offer ][ "seller_txid" ] = txinfo[ 0 ];
                        dealership[ "offers" ][ offer ][ "seller_vout" ] = txinfo[ 1 ];
                        var another_bitcoin_address = "miCsGRg9GTKWfKDPGUhQ2jf5srtD4e9M2Q";
                        dealership[ "offers" ][ offer ][ "seller_address" ] = another_bitcoin_address;
                        var sellers_contract = dealership[ "offers" ][ offer ].sellers_contract.contract;
                        $( 'h2' ).remove();
                        $( 'p' ).remove();
                        var hd = document.createElement( "h2" );
                        hd.innerText = "ok send this to the buyer:";
                        $( '.procedure' ).append( hd );
                        var pg = document.createElement( "p" );
                        pg.innerText = JSON.stringify( {sellers_address: another_bitcoin_address, sellers_contract} );
                        $( '.procedure' ).append( pg );
                        var btn3 = document.createElement( "button" );
                        btn3.classList.add( "info_sent" );
                        btn3.innerText = "click when the info is sent";
                        setNostrNote( encrypt( privKey, event.pubkey, JSON.stringify( {type: "info_for_buyer", msg: {offer, sellers_address: another_bitcoin_address, sellers_contract}} ) ), event.pubkey, relay );
                    }
                    if ( content[ "type" ] == "info_for_buyer" ) {
                        var info_for_buyer = content[ "msg" ];
                        var offer = info_for_buyer[ "offer" ];
                        var sellers_contract = info_for_buyer[ "sellers_contract" ];
                        var sellers_address = info_for_buyer[ "sellers_address" ];
                        if ( $_GET[ "network" ] == "regtest" ) {
                            var txid = prompt( "enter the txid you just entered" );
                            var vout = prompt( "and the vout you just entered" );
                            vout = Number( vout );
                            var txinfo = [txid, vout, 3000];
                            // var txinfo = ["ab".repeat( 32 ), 0, 3000];
                        } else {
                            //change to testnet/
                            var txinfo = await dealership.addressReceivedMoneyInThisTx( sellers_contract.address, "" )
                        }
                        if ( txinfo[ 2 ] != 3_000 ) return;
                        dealership[ "offers" ][ offer ][ "seller_txid" ] = txinfo[ 0 ];
                        dealership[ "offers" ][ offer ][ "seller_vout" ] = txinfo[ 1 ];
                        dealership[ "offers" ][ offer ][ "seller_address" ] = sellers_address;
                        dealership[ "offers" ][ offer ].sellers_contract.contract = sellers_contract;
                        var buyer_second_privkey = dealership[ "offers" ][ offer ].buyers_contract.second_privkey1;
                        var buyer_preimage = dealership[ "offers" ][ offer ].buyers_contract.preimage;
                        var hd = document.createElement( "h2" );
                        hd.innerText = "waiting for the seller's sats";
                        $( '.procedure' ).append( hd );
                        setNostrNote( encrypt( privKey, event.pubkey, JSON.stringify( {type: "more_info_for_seller", msg: {offer, buyer_preimage, buyer_second_privkey}} ) ), event.pubkey, relay );
                        $( 'h2' ).remove();
                    }
                    if ( content[ "type" ] == "more_info_for_seller" ) {
                        var more_info_for_seller = content[ "msg" ];
                        var offer = more_info_for_seller[ "offer" ];
                        var hash = await dealership.sha256( dealership.hexToBytes( more_info_for_seller[ "buyer_preimage" ] ) );
                        if ( hash != dealership[ "offers" ][ offer ].sellers_contract.contract.hash ) return;
                        var buyer_second_privkey = more_info_for_seller[ "buyer_second_privkey" ];
                        var txhex = await dealership.useTweakAsSeller( dealership[ "offers" ][ offer ].sellers_contract.privkey2, buyer_second_privkey, offer );
                        console.log( "txhex:", txhex );
                        alert( `ok you're the seller now -- broadcast this tx, then click ok:\n\n${txhex}` );
                        var seller_second_privkey = dealership[ "offers" ][ offer ].sellers_contract.second_privkey2;
                        var hd = document.createElement( "h2" );
                        hd.innerText = "send this info to the buyer";
                        $( '.procedure' ).append( hd );
                        var pg = document.createElement( "p" );
                        pg.innerText = JSON.stringify( {seller_second_privkey} );
                        $( '.procedure' ).append( pg );
                        setNostrNote( encrypt( privKey, event.pubkey, JSON.stringify( {type: "more_info_for_buyer", msg: {offer, seller_second_privkey}} ) ), event.pubkey, relay );
                        $( 'h2' ).remove();
                        $( 'p' ).remove();
                        $( 'h2' ).remove();
                        $( 'p' ).remove();
                        var hd = document.createElement( "h2" );
                        hd.innerText = "you're done!";
                        $( '.procedure' ).append( hd );
                        //return here for seller
                    }
                    if ( content[ "type" ] == "more_info_for_buyer" ) {
                        var more_info_for_buyer = content[ "msg" ];
                        var offer = more_info_for_buyer[ "offer" ];
                        $( 'h2' ).remove();
                        var seller_second_privkey = more_info_for_buyer[ "seller_second_privkey" ];
                        var txhex = await dealership.useTweakAsBuyer( dealership[ "offers" ][ offer ].buyers_contract.privkey1, seller_second_privkey, offer );
                        console.log( "txhex:", txhex );
                        alert( `ok you're the buyer now -- broadcast this tx, then click ok:\n\n${txhex}` );
                        var hd = document.createElement( "h2" );
                        hd.innerText = "you're done!";
                        $( '.procedure' ).append( hd );
                        //return here for buyer
                    }
                }
                //stop here if you are the seller
                if ( kind !== 63582 || $_GET[ "user" ] != "buyer" ) return;
                content = JSON.parse( content );
                if ( $( 'button' ) ) $( 'button' ).remove();
                var btn = document.createElement( "button" );
                btn.classList.add( "buy_utxo" );
                btn.innerText = "buy 3000 sats for 4000 sats";
                btn.setAttribute( "data-offer", event.id );
                btn.setAttribute( "data-pubkey", content.sellers_pubkey );
                btn.setAttribute( "data-second_pubkey", content.second_sellers_pubkey );
                btn.setAttribute( "data-nostrpub", event.pubkey );
                btn.onclick = async e => {
                    var offer = e.target.getAttribute( "data-offer" );
                    dealership[ "offers" ][ offer ] = {}
                    dealership[ "offers" ][ offer ][ "buyers_contract" ] = {}
                    dealership[ "offers" ][ offer ][ "sellers_contract" ] = {}
                    dealership[ "offers" ][ offer ][ "buyer_txid" ] = null;
                    dealership[ "offers" ][ offer ][ "buyer_vout" ] = null;
                    dealership[ "offers" ][ offer ][ "seller_txid" ] = null;
                    dealership[ "offers" ][ offer ][ "seller_vout" ] = null;
                    dealership[ "offers" ][ offer ][ "seller_address" ] = null;
                    dealership[ "offers" ][ offer ][ "buyer_address" ] = null;
                    var sellers_pubkey = ( e.target.getAttribute( "data-pubkey" ) );
                    var second_sellers_pubkey = e.target.getAttribute( "data-second_pubkey" );
                    await dealership.prepBuyer( sellers_pubkey, second_sellers_pubkey, offer );
                    $( 'h2' ).remove();
                    $( '.buy_utxo' ).style.display = "none";
                    var hd = document.createElement( "h2" );
                    hd.innerText = "ok send 4000 sats to this address:";
                    $( '.procedure' ).append( hd );
                    var pg = document.createElement( "p" );
                    pg.innerText = dealership[ "offers" ][ offer ].buyers_contract.contract.address;
                    console.log( 4000, dealership[ "offers" ][ offer ].buyers_contract.contract.address );
                    $( '.procedure' ).append( pg );
                    await dealership.waitSomeSeconds( 3 );
                    if ( $_GET[ "network" ] == "regtest" ) {
                        var txid = prompt( "enter the txid" );
                        var vout = prompt( "and the vout" );
                        vout = Number( vout );
                        var txinfo = [txid, vout, 4000];
                        // var txinfo = ["ab".repeat( 32 ), 0, 4000];
                    } else {
                        //change to testnet/
                        await dealership.loopTilAddressReceivesMoney( dealership[ "offers" ][ offer ].buyers_contract.contract.address, "" );
                        //change to testnet/
                        var txinfo = await dealership.addressReceivedMoneyInThisTx( dealership[ "offers" ][ offer ].buyers_contract.contract.address, "" );
                    }
                    dealership[ "offers" ][ offer ][ "buyer_txid" ] = txinfo[ 0 ];
                    dealership[ "offers" ][ offer ][ "buyer_vout" ] = txinfo[ 1 ];
                    var some_bitcoin_address = "mkHS9ne12qx9pS9VojpwU5xtRd4T7X7ZUt";
                    dealership[ "offers" ][ offer ][ "buyer_address" ] = some_bitcoin_address;
                    var buyers_contract = dealership[ "offers" ][ offer ].buyers_contract.contract;
                    $( 'h2' ).remove();
                    $( 'p' ).remove();
                    var hd = document.createElement( "h2" );
                    hd.innerText = "waiting for the seller's okay";
                    $( '.procedure' ).append( hd );
                    var recipient = $( 'button' ).getAttribute( "data-nostrpub" );
                    setNostrNote( encrypt( privKey, recipient, JSON.stringify( {type: "accept", msg: {offer, buyers_address: some_bitcoin_address, buyers_contract}} ) ), recipient, relay );
                }
                $( '.procedure' ).append( btn );
            });

            socket.addEventListener('open', async function( e ) {
                console.log( "connected to " + relay );
                var subId   = bitcoinjs.ECPair.makeRandom().privateKey.toString( "hex" ).substring( 0, 16 );
                var filter  = { "#p": [ pubKey ] }
                var filter2  = { kinds: [ 63582 ], since: Math.floor( Date.now() / 1000 ) }
                // var filter3  = { kinds: [ 63582 ], limit: 1 }
                // var subscription = [ "REQ", subId, filter, filter2, filter3 ];
                var subscription = [ "REQ", subId, filter, filter2 ];
                socket.send(JSON.stringify( subscription ));
            });
            async function getSignedEvent(event, privateKey) {
                var eventData = JSON.stringify([
                    0,                  // Reserved for future use
                    event['pubkey'],        // The sender's public key
                    event['created_at'],    // Unix timestamp
                    event['kind'],      // Message “kind” or type
                    event['tags'],      // Tags identify replies/recipients
                    event['content']        // Your note contents
                ])
                event.id  = sha256( eventData ).toString( 'hex' );
                event.sig = await schnorr.sign( event.id, privateKey );
                return event;
            }
            function hexToBytes( hex ) {
                return Uint8Array.from( hex.match( /.{1,2}/g ).map( ( byte ) => parseInt( byte, 16 ) ) );
            }

            function bytesToHex( bytes ) {
                return bytes.reduce( ( str, byte ) => str + byte.toString( 16 ).padStart( 2, '0' ), '' );
            }
            function base64ToHex( str ) {
                var raw = atob( str );
                var result = '';
                var i; for ( i=0; i<raw.length; i++ ) {
                    var hex = raw.charCodeAt( i ).toString( 16 );
                    result += ( hex.length === 2 ? hex : '0' + hex );
                }
                return result;
            }
            function encrypt( privkey, pubkey, text ) {
                var key = nobleSecp256k1.getSharedSecret( privkey, '02' + pubkey, true ).substring( 2 );
                var iv = window.crypto.getRandomValues(new Uint8Array(16));
                var cipher = browserifyCipher.createCipheriv( 'aes-256-cbc', hexToBytes( key ), iv );
                var encryptedMessage = cipher.update(text,"utf8","base64");
                emsg = encryptedMessage + cipher.final( "base64" );
                var uint8View = new Uint8Array( iv.buffer );
                var decoder = new TextDecoder();
                return emsg + "?iv=" + btoa( String.fromCharCode.apply( null, uint8View ) );
            }
            function decrypt( privkey, pubkey, ciphertext ) {
                var [ emsg, iv ] = ciphertext.split( "?iv=" );
                var key = nobleSecp256k1.getSharedSecret( privkey, '02' + pubkey, true ).substring( 2 );
                var decipher = browserifyCipher.createDecipheriv(
                    'aes-256-cbc',
                    hexToBytes( key ),
                    hexToBytes( base64ToHex( iv ) )
                );
                var decryptedMessage = decipher.update( emsg, "base64" );
                dmsg = decryptedMessage + decipher.final( "utf8" );
                return dmsg;
            }
            var setNostrNote = async ( note, recipient, relay ) => {
                var event = {
                    "content": note,
                    "created_at": Math.floor( Date.now() / 1000 ),
                    "kind": recipient ? 4 : 63582,
                    "tags": recipient ? [ [ "p", recipient ] ] : [],
                    "pubkey": pubKey
                }
                var signedEvent = await getSignedEvent( event, privKey );
                var mysocket = new WebSocket( relay );
                mysocket.addEventListener( "open", () => mysocket.send( JSON.stringify( ["EVENT", signedEvent ] ) ) );
                return signedEvent.id;
            }
        </script>
        <script>
            var dealership = {}
            dealership[ "hexToBytes" ] = hex => Uint8Array.from( hex.match( /.{1,2}/g ).map( ( byte ) => parseInt( byte, 16 ) ) );
            dealership[ "bytesToHex" ] = bytes => bytes.reduce( ( str, byte ) => str + byte.toString( 16 ).padStart( 2, "0" ), "" );
            dealership[ "sha256" ] = s => {
                if ( typeof s == "string" ) s = new TextEncoder().encode( s );
                return crypto.subtle.digest( 'SHA-256', s ).then( hashBuffer => {
                    var hashArray = Array.from( new Uint8Array( hashBuffer ) );
                    var hashHex = hashArray
                        .map( bytes => bytes.toString( 16 ).padStart( 2, '0' ) )
                        .join( '' );
                    return hashHex;
                });
            }
            dealership[ "getPrivateKey" ] = () => {
                var privkey = dealership.bytesToHex(nobleSecp256k1.utils.randomPrivateKey());
                if ( nobleSecp256k1.getPublicKey( privkey, true ).startsWith( "03" ) ) {
                    privkey = dealership.negatePrivkey( privkey );
                    var padding = "0".repeat( 64 );
                    padding = padding + privkey;
                    privkey = padding.slice( -64 );
                }
                return privkey;
            }
            dealership[ "getPublicKey" ] = privkey => {
                if ( !privkey ) console.log( "no privkey!", privkey );
                if ( privkey.length != 64 ) console.log( "privkey not 32 bytes!", privkey );
                return nobleSecp256k1.getPublicKey( privkey, true ).substring( 2 );
            }
            dealership[ "negatePrivkey" ] = privkey => {
                return ( nobleSecp256k1.CURVE.n - BigInt( "0x" + privkey ) ).toString( 16 );
            }
            dealership[ "waitSomeSeconds" ] = num => {
                var num = num.toString() + "000";
                num = Number( num );
                return new Promise( resolve => setTimeout( resolve, num ) );
            }
            dealership[ "getData" ] = async url => {
                return new Promise( async function( resolve, reject ) {
                    function inner_get( url ) {
                        var xhttp = new XMLHttpRequest();
                        xhttp.open( "GET", url, true );
                        xhttp.send();
                        return xhttp;
                    }
                    var data = inner_get( url );
                    data.onerror = function( e ) {
                        resolve( "error" );
                    }
                    async function isResponseReady() {
                        return new Promise( function( resolve2, reject ) {
                            if ( !data.responseText || data.readyState != 4 ) {
                                setTimeout( async function() {
                                    var msg = await isResponseReady();
                                    resolve2( msg );
                                }, 1 );
                            } else {
                                resolve2( data.responseText );
                            }
                        });
                    }
                    var returnable = await isResponseReady();
                    resolve( returnable );
                });
            }
            dealership[ "postData" ] = async (url, json, content_type = "", apikey = "") => {
                var rtext = "";
                function inner_post( url, json, content_type = "", apikey = "" ) {
                    var xhttp = new XMLHttpRequest();
                    xhttp.open( "POST", url, true );
                    if ( content_type ) {
                        xhttp.setRequestHeader( `Content-Type`, content_type );
                    }
                    if ( apikey ) {
                        xhttp.setRequestHeader( `X-Api-Key`, apikey );
                    }
                    xhttp.send( json );
                    return xhttp;
                }
                var data = inner_post( url, json, content_type, apikey );
                data.onerror = function( e ) {
                    rtext = "error";
                }
                async function isResponseReady() {
                    return new Promise( function( resolve, reject ) {
                        if ( rtext == "error" ) {
                            resolve( rtext );
                        }
                        if ( !data.responseText || data.readyState != 4 ) {
                            setTimeout( async function() {
                                var msg = await isResponseReady();
                                resolve( msg );
                            }, 50 );
                        } else {
                            resolve( data.responseText );
                        }
                    });
                }
                var returnable = await isResponseReady();
                return returnable;
            }
            dealership[ "pushBTCpmt" ] = async( rawtx, network ) => {
                var txid = await dealership.postData( "https://mutinynet.com/" + network + "api/tx", rawtx );
                return txid;
            }
            dealership[ "addressReceivedMoneyInThisTx" ] = async (address, network) => {
                let txid;
                let vout;
                let amt;
                let nonjson = await dealership.getData("https://mutinynet.com/" + network + "api/address/" + address + "/txs");
                let json = JSON.parse(nonjson);
                json.forEach(function (tx) {
                    tx["vout"].forEach(function (output, index) {
                        if (output["scriptpubkey_address"] == address) {
                            txid = tx["txid"];
                            vout = index;
                            amt = output["value"];
                        }
                    });
                });
                return [txid, vout, amt];
            }
            dealership[ "loopTilAddressReceivesMoney" ] = async (address, network) => {
                let itReceivedMoney = false;
                async function isDataSetYet(data_i_seek) {
                    return new Promise(function (resolve, reject) {
                        if (!data_i_seek) {
                            setTimeout(async function () {
                                console.log("waiting for address to receive money...");
                                try {
                                    itReceivedMoney = await dealership.addressOnceHadMoney(address, network);
                                }catch(e){ }
                                let msg = await isDataSetYet(itReceivedMoney);
                                resolve(msg);
                            }, 2000);
                        } else {
                            resolve(data_i_seek);
                        }
                    });
                }

                async function getTimeoutData() {
                    let data_i_seek = await isDataSetYet(itReceivedMoney);
                    return data_i_seek;
                }

                let returnable = await getTimeoutData();
                return returnable;
            }
            dealership[ "addressOnceHadMoney" ] = async (address, network) => {
                var nonjson = await dealership.getData( "https://mutinynet.com/" + network + "api/address/" + address );
                var json = JSON.parse( nonjson );
                if ( json[ "chain_stats" ][ "tx_count" ] > 0 || json[ "mempool_stats" ][ "tx_count" ] > 0 ) {
                    return true;
                }
                return false;
            }
            dealership[ "add2Pubkeys" ] = (pubkey1, pubkey2, caller) => {
                var combokey = nobleSecp256k1.Point.fromHex( pubkey1 ).add( nobleSecp256k1.Point.fromHex( pubkey2 ) ).toHex();
                var compressed = bitcoinjs.ECPair.fromPublicKey( Buffer.from( combokey, "hex" ) ).publicKey.toString( "hex" );
                return compressed;
            }
            dealership[ "add2Privkeys" ] = (privkey1, privkey2) => {
                var combokey = ( ( BigInt( "0x" + privkey1 ) + BigInt( "0x" + privkey2 ) ) % nobleSecp256k1.CURVE.n ).toString( 16 );
                var padding = "0".repeat( 64 );
                padding = padding + combokey;
                combokey = padding.slice( -64 );
                return combokey;
            }
            dealership[ "tweakAndNegateIfOdd" ] = (privkey, tweak) => {
                var tweaked_key = dealership.add2Privkeys( privkey, tweak );
                var tweaked_pubkey = nobleSecp256k1.getPublicKey( tweaked_key, true );
                var negated = ( ( nobleSecp256k1.CURVE.n - BigInt( "0x" + tweaked_key ) ) ).toString( 16 );
                if ( tweaked_pubkey.startsWith( "02" ) ) return tweaked_key;
                return negated;
            }
            dealership[ "makeContract" ] = async (offer, pubkey2, second_pubkey2, pubkey1, second_pubkey1, privkey2, second_privkey2, hash, i_am_seller) => {
                var timelock = 10;
                var preimage = dealership.getPrivateKey();
                if ( !hash ) {
                    var privkey1 = dealership.getPrivateKey();
                    var second_buyer_privkey = dealership.getPrivateKey();
                    var pubkey1 = dealership.getPublicKey( privkey1 );
                    var second_buyer_pubkey = dealership.getPublicKey( second_buyer_privkey );
                    var hash = await dealership.sha256( dealership.hexToBytes( preimage ) );
                    dealership[ "offers" ][ offer ][ "buyers_contract" ][ "second_privkey1" ] = second_buyer_privkey;
                    // console.log( "combokey for the swap address created by the buyer:", dealership.add2Pubkeys( pubkey2, second_buyer_pubkey, `makeContract` ).substring( 2 ), ` -- I passed in pubkey2 (i.e. ${pubkey2}, whose privkey the seller knows, you can look it up with dealership.sellers_contract.privkey2) and second_buyer_pubkey (i.e. ${second_buyer_pubkey}, whose privkey the buyer knows, it is ${dealership.buyers_contract.second_privkey1})` );
                    var contract = await dealership.getContract( pubkey1, second_buyer_pubkey, pubkey2, second_pubkey2, timelock, hash );
                } else {
                    timelock = timelock - 5;
                    dealership[ "offers" ][ offer ][ "sellers_contract" ][ "second_privkey2" ] = second_privkey2;
                    // console.log( "combokey for the swap address created by the seller:", dealership.add2Pubkeys( second_pubkey2, pubkey1, `makeContract` ).substring( 2 ), ` -- I passed in second_pubkey2 (i.e. ${second_pubkey2}, whose privkey the seller knows, it is ${dealership[ "offers" ][ offer ].sellers_contract.second_privkey2}) and pubkey1 (i.e. ${pubkey1}, whose privkey the buyer knows -- you can look it up with dealership.buyers_contract.privkey1)` );
                    var contract = await dealership.getContract( pubkey2, second_pubkey2, pubkey1, second_pubkey1, timelock, hash );
                }
                if ( !i_am_seller ) return {privkey1, second_privkey1: second_buyer_privkey, preimage, contract}
                return {privkey2, second_privkey2, contract}
            }
            dealership[ "getContract" ] = async (pubkey1, second_pubkey1, pubkey2, second_pubkey2, timelock, hash) => {
                // the pre-tweaked pubkey will always be the counterparty's pubkey plus the current user's
                // second pubkey -- e.g. the first time the contract is created, the buyer makes it, and he
                // uses his counterparty's pubkey (pubkey2) plus his own second pubkey (second_pubkey1) --
                // that way he can reveal the privkey of second_pubkey1 to the seller and the seller will
                // be able to spend the money, because he already has the privkey to pubkey2
                // the second time the contract is created, the seller makes it, and he passes in his own
                // key -- second_pubkey2 -- in the place where the buyer passed in pubkey2 (so that's
                // backwards) and his counterparty's pubkey -- pubkey1 -- in the place where the buyer
                // passed in pubkey1 -- so that's backwards too, but that should cancel out and be fine
                var scripts = [
                    [
                        timelock,
                        'OP_CHECKSEQUENCEVERIFY',
                        'OP_DROP',
                        pubkey1,
                        'OP_CHECKSIG'
                    ],
                    [
                        'OP_SHA256',
                        hash,
                        'OP_EQUALVERIFY',
                        pubkey2,
                        'OP_CHECKSIG'
                    ]
                ];
                var tree = scripts.map(s => tapscript.Tap.encodeScript(s));
                var index  = 0; //alternative: 1
                var script = scripts[index];
                var target = tapscript.Tap.encodeScript(script);
                var pubkey = dealership.add2Pubkeys( pubkey2, second_pubkey1, `getContract` ).substring( 2 );
                var [ tpubkey ] = tapscript.Tap.getPubKey(pubkey, { tree, target });
                //change to testnet
                if ( $_GET[ "network" ] == "regtest" ) var address = tapscript.Address.p2tr.fromPubKey(tpubkey, 'regtest');
                else var address = tapscript.Address.p2tr.fromPubKey(tpubkey, 'testnet');
                return {address, pubkey1, second_pubkey1, pubkey2, second_pubkey2, timelock, hash};
            }
            dealership[ "settleContract" ] = async (offer, privkey, pubkey1, second_pubkey1, pubkey2, second_pubkey2, index, destino, from_amount, to_amount, timelock, sig2, preimage, hash, txid, vout, i_am_buyer, set_sequence_as_seller, disable_sequence) => {
                var scripts = [
                    [
                        timelock,
                        'OP_CHECKSEQUENCEVERIFY',
                        'OP_DROP',
                        pubkey1,
                        'OP_CHECKSIG'
                    ],
                    [
                        'OP_SHA256',
                        hash,
                        'OP_EQUALVERIFY',
                        pubkey2,
                        'OP_CHECKSIG'
                    ]
                ];
                var tree = scripts.map(s => tapscript.Tap.encodeScript(s));
                var script = scripts[index];
                var target = tapscript.Tap.encodeScript(script);
                var pubkey = dealership.add2Pubkeys( pubkey2, second_pubkey1, `settleContract` ).substring( 2 );
                var [ tpubkey, cblock ] = tapscript.Tap.getPubKey(pubkey, { tree, target });
                var txdata = tapscript.Tx.create({
                  vin: [{
                    txid: txid,
                    vout: vout,
                    prevout: {value: from_amount, scriptPubKey: ["OP_1", tpubkey]},
                    sequence: ( ( i_am_buyer || set_sequence_as_seller ) && !disable_sequence ) ? ( timelock ).toString( 16 ).padStart( 8, "0" ) : 0xffffffff,
                    witness: []
                  }],
                  vout: [{
                    value: to_amount,
                    scriptPubKey: tapscript.Address.toScriptPubKey(destino)
                  }],
                });
                var vin_to_sign = 0;
                var sighash = tapscript.Signer.taproot.hash( txdata, vin_to_sign, {extension: target, pubkey: dealership.getPublicKey( privkey )} ).hex;
                var sig1 = tapscript.Signer.taproot.sign(privkey, txdata, vin_to_sign, { extension: target });
                var sig_is_good = await nobleSecp256k1.schnorr.verify( sig1.hex, sighash, dealership.getPublicKey( privkey ) );
                txdata.vin[0].witness = [ sig1, script, cblock ];
                if ( preimage ) txdata.vin[0].witness = [ sig1, preimage, script, cblock ];
                if ( sig2 ) txdata.vin[0].witness = [ sig1, sig2, script, cblock ];
                return tapscript.Tx.encode(txdata).hex;
            }
            dealership[ "offers" ] = {}
            dealership[ "prepBuyer" ] = async (pubkey2, second_sellers_pubkey, offer) => {
                dealership[ "offers" ][ offer ][ "buyers_contract" ] = await dealership.makeContract( offer, pubkey2, second_sellers_pubkey );
                return true;
            }
            dealership[ "refundBuyer" ] = async offer => {
                var privkey = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "privkey1" ];
                var pubkey1 = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "pubkey1" ];
                var pubkey2 = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "pubkey2" ];
                var second_pubkey1 = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "second_pubkey1" ];
                var second_pubkey2 = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "second_pubkey2" ];
                var index = 0;
                var destino = dealership[ "offers" ][ offer ][ "buyer_address" ];
                var from_amount = 4_000;
                var to_amount = from_amount - 500;
                var timelock = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "timelock" ];
                var sig2 = null;
                var preimage = null;
                var hash = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "hash" ];
                var txid = dealership[ "offers" ][ offer ][ "buyer_txid" ];
                var vout = dealership[ "offers" ][ offer ][ "buyer_vout" ];
                var i_am_buyer = true;
                var txhex = await dealership.settleContract(offer, privkey, pubkey1, second_pubkey1, pubkey2, second_pubkey2, index, destino, from_amount, to_amount, timelock, sig2, preimage, hash, txid, vout, i_am_buyer);
                return txhex;
                // remember not to broadcast your tx til the timelock expires
            }
            dealership[ "usePreimageAsSeller" ] = async (privkey, offer) => {
                var pubkey1 = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "pubkey1" ];
                var pubkey2 = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "pubkey2" ];
                var second_pubkey1 = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "second_pubkey1" ];
                var second_pubkey2 = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "second_pubkey2" ];
                var index = 1;
                var destino = dealership[ "offers" ][ offer ][ "seller_address" ];
                var from_amount = 4_000;
                var to_amount = from_amount - 500;
                var timelock = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "timelock" ];
                var sig2 = null;
                var preimage = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "preimage" ];
                var hash = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "hash" ];
                var txid = dealership[ "offers" ][ offer ][ "buyer_txid" ];
                var vout = dealership[ "offers" ][ offer ][ "buyer_vout" ];
                var i_am_buyer = false;
                var txhex = await dealership.settleContract(offer, privkey, pubkey1, second_pubkey1, pubkey2, second_pubkey2, index, destino, from_amount, to_amount, timelock, sig2, preimage, hash, txid, vout, i_am_buyer);
                return txhex;
            }
            dealership[ "useTweakAsSeller" ] = async ( privkey, tweak, offer ) => {
                var tweaked_privkey = dealership.tweakAndNegateIfOdd( privkey, tweak );
                var desired_combo = dealership.add2Pubkeys( dealership.getPublicKey( privkey ), dealership.getPublicKey( tweak ) ).substring( 2 );
                var actual_combo = dealership.getPublicKey( tweaked_privkey );
                if ( actual_combo != desired_combo ) {
                    var txhex = await dealership.usePreimageAsSeller( privkey, offer );
                    return txhex;
                }
                var pubkey1 = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "pubkey1" ];
                var pubkey2 = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "pubkey2" ];
                var second_pubkey1 = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "second_pubkey1" ];
                var second_pubkey2 = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "second_pubkey2" ];
                var destino = dealership[ "offers" ][ offer ][ "seller_address" ];
                var from_amount = 4_000;
                var to_amount = from_amount - 500;
                var timelock = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "timelock" ];
                var preimage = null;
                var hash = dealership[ "offers" ][ offer ][ "sellers_contract" ][ "contract" ][ "hash" ];
                var txid = dealership[ "offers" ][ offer ][ "buyer_txid" ];
                var vout = dealership[ "offers" ][ offer ][ "buyer_vout" ];
                var i_am_buyer = false;
                var scripts = [
                    [
                        timelock,
                        'OP_CHECKSEQUENCEVERIFY',
                        'OP_DROP',
                        pubkey1,
                        'OP_CHECKSIG'
                    ],
                    [
                        'OP_SHA256',
                        hash,
                        'OP_EQUALVERIFY',
                        pubkey2,
                        'OP_CHECKSIG'
                    ]
                ];
                var tree = scripts.map(s => tapscript.Tap.encodeScript(s));
                var [ tseckey ] = tapscript.Tap.getSecKey( tweaked_privkey, { tree } )
                var pubkey = dealership.add2Pubkeys( pubkey2, second_pubkey1, `useTweakAsSeller` ).substring( 2 );
                var [ tpubkey ] = tapscript.Tap.getPubKey(pubkey, { tree });
                var txdata = tapscript.Tx.create({
                  vin: [{
                    txid: txid,
                    vout: vout,
                    prevout: {value: from_amount, scriptPubKey: ["OP_1", tpubkey]},
                    sequence: 0xffffffff,
                    witness: []
                  }],
                  vout: [{
                    value: to_amount,
                    scriptPubKey: tapscript.Address.toScriptPubKey(destino)
                  }],
                });
                var vin_to_sign = 0;
                var sighash = tapscript.Signer.taproot.hash( txdata, vin_to_sign ).hex;
                var sig = tapscript.Signer.taproot.sign(tseckey, txdata, vin_to_sign);
                txdata.vin[0].witness = [ sig ];
                return tapscript.Tx.encode(txdata).hex;
            }
            dealership[ "useTweakAsBuyer" ] = async ( privkey, tweak, offer ) => {
                var tweaked_privkey = dealership.tweakAndNegateIfOdd( privkey, tweak );
                var desired_combo = dealership.add2Pubkeys( dealership.getPublicKey( privkey ), dealership.getPublicKey( tweak ) ).substring( 2 );
                var actual_combo = dealership.getPublicKey( tweaked_privkey );
                if ( actual_combo != desired_combo ) {
                    var txhex = await dealership.usePreimageAsBuyer( privkey, offer );
                    return txhex;
                }
                //remember that the pubkeys are reversed in the next two lines
                var pubkey2 = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "pubkey1" ];
                var pubkey1 = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "pubkey2" ];
                var second_pubkey2 = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "second_pubkey1" ];
                var second_pubkey1 = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "second_pubkey2" ];
                var destino = dealership[ "offers" ][ offer ][ "buyer_address" ];
                var from_amount = 3_000;
                var to_amount = from_amount - 500;
                var timelock = dealership[ "offers" ][ offer ][ "sellers_contract" ][ "contract" ][ "timelock" ];
                var preimage = null;
                var hash = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "hash" ];
                var txid = dealership[ "offers" ][ offer ][ "seller_txid" ];
                var vout = dealership[ "offers" ][ offer ][ "seller_vout" ];
                var i_am_buyer = true;
                var scripts = [
                    [
                        timelock,
                        'OP_CHECKSEQUENCEVERIFY',
                        'OP_DROP',
                        pubkey1,
                        'OP_CHECKSIG'
                    ],
                    [
                        'OP_SHA256',
                        hash,
                        'OP_EQUALVERIFY',
                        pubkey2,
                        'OP_CHECKSIG'
                    ]
                ];
                var tree = scripts.map(s => tapscript.Tap.encodeScript(s));
                var [ tseckey ] = tapscript.Tap.getSecKey( tweaked_privkey, { tree } )
                var pubkey = dealership.add2Pubkeys( pubkey2, second_pubkey1, `useTweakAsSeller` ).substring( 2 );
                var [ tpubkey ] = tapscript.Tap.getPubKey(pubkey, { tree });
                var txdata = tapscript.Tx.create({
                  vin: [{
                    txid: txid,
                    vout: vout,
                    prevout: {value: from_amount, scriptPubKey: ["OP_1", tpubkey]},
                    sequence: 0xffffffff,
                    witness: []
                  }],
                  vout: [{
                    value: to_amount,
                    scriptPubKey: tapscript.Address.toScriptPubKey(destino)
                  }],
                });
                var vin_to_sign = 0;
                var sig = tapscript.Signer.taproot.sign(tseckey, txdata, vin_to_sign);
                txdata.vin[0].witness = [ sig ];
                return tapscript.Tx.encode(txdata).hex;
            }
            dealership[ "prepSeller" ] = async (privkey2, second_privkey2, offer) => {
                var pubkey1 = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "pubkey1" ];
                var second_pubkey1 = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "second_pubkey1" ];
                var pubkey2 = dealership.getPublicKey( dealership[ "offers" ][ offer ][ "sellers_privkey" ] );
                var second_pubkey2 = dealership.getPublicKey( dealership[ "offers" ][ offer ][ "second_sellers_privkey" ] );
                var hash = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "hash" ];
                dealership[ "offers" ][ offer ][ "sellers_contract" ] = await dealership.makeContract( offer, pubkey2, second_pubkey2, pubkey1, second_pubkey1, privkey2, second_privkey2, hash, true );
                return true;
            }
            dealership[ "refundSeller" ] = async offer => {
                var privkey = dealership[ "offers" ][ offer ][ "sellers_contract" ][ "privkey2" ];
                var pubkey1 = dealership[ "offers" ][ offer ][ "sellers_contract" ][ "contract" ][ "pubkey1" ];
                var pubkey2 = dealership[ "offers" ][ offer ][ "sellers_contract" ][ "contract" ][ "pubkey2" ];
                var second_pubkey1 = dealership[ "offers" ][ offer ][ "sellers_contract" ][ "contract" ][ "second_pubkey1" ];
                var second_pubkey2 = dealership[ "offers" ][ offer ][ "sellers_contract" ][ "contract" ][ "second_pubkey2" ];
                var index = 0;
                var destino = dealership[ "offers" ][ offer ][ "seller_address" ];
                var from_amount = 3_000;
                var to_amount = from_amount - 500;
                var timelock = dealership[ "offers" ][ offer ][ "sellers_contract" ][ "contract" ][ "timelock" ];
                var sig2 = null;
                var preimage = null;
                var hash = dealership[ "offers" ][ offer ][ "sellers_contract" ][ "contract" ][ "hash" ];
                var txid = dealership[ "offers" ][ offer ][ "seller_txid" ];
                var vout = dealership[ "offers" ][ offer ][ "seller_vout" ];
                var i_am_buyer = false;
                var txhex = await dealership.settleContract(offer, privkey, pubkey1, second_pubkey1, pubkey2, second_pubkey2, index, destino, from_amount, to_amount, timelock, sig2, preimage, hash, txid, vout, i_am_buyer, true);
                return txhex;
                // remember not to broadcast your tx til the timelock expires
            }
            dealership[ "usePreimageAsBuyer" ] = async (privkey, offer) => {
                //remember that the pubkeys are reversed in the next two lines
                var pubkey2 = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "pubkey1" ];
                var pubkey1 = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "pubkey2" ];
                var second_pubkey2 = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "second_pubkey1" ];
                var second_pubkey1 = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "second_pubkey2" ];
                var index = 1;
                var destino = dealership[ "offers" ][ offer ][ "buyer_address" ];
                var from_amount = 3_000;
                var to_amount = from_amount - 500;
                var timelock = dealership[ "offers" ][ offer ][ "sellers_contract" ][ "contract" ][ "timelock" ];
                var sig2 = null;
                var preimage = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "preimage" ];
                var hash = dealership[ "offers" ][ offer ][ "buyers_contract" ][ "contract" ][ "hash" ];
                var txid = dealership[ "offers" ][ offer ][ "seller_txid" ];
                var vout = dealership[ "offers" ][ offer ][ "seller_vout" ];
                var i_am_buyer = true;
                var txhex = await dealership.settleContract(offer, privkey, pubkey1, second_pubkey1, pubkey2, second_pubkey2, index, destino, from_amount, to_amount, timelock, sig2, preimage, hash, txid, vout, i_am_buyer, null, true);
                return txhex;
            }
        </script>
    </head>
    <body>
        <h1>Utxo Dealership</h1>
        <div class="procedure">
            <h2>You are the seller -- click the button below</h2>
            <button class="sell_utxo">Sell your new utxo</button>
        </div>
        <script>
            if ( $_GET[ "user" ] == "buyer" ) {
                $( 'h2' ).remove();
                $( '.sell_utxo' ).remove();
                var hd = document.createElement( "h2" );
                hd.innerText = "You are the buyer -- buy a new utxo";
                $( '.procedure' ).append( hd );
            }
            if ( $( '.sell_utxo' ) ) $( '.sell_utxo' ).onclick = async () => {
                $( 'h2' ).remove();
                $( '.sell_utxo' ).remove();
                var sellers_privkey = dealership.getPrivateKey();
                var second_sellers_privkey = dealership.getPrivateKey();
                var sellers_pubkey = dealership.getPublicKey( sellers_privkey );
                var second_sellers_pubkey = dealership.getPublicKey( second_sellers_privkey );
                var offer = await setNostrNote( JSON.stringify({sellers_pubkey, second_sellers_pubkey}), null, relay );
                dealership[ "offers" ][ offer ] = {}
                dealership[ "offers" ][ offer ][ "sellers_privkey" ] = sellers_privkey;
                dealership[ "offers" ][ offer ][ "second_sellers_privkey" ] = second_sellers_privkey;
                dealership[ "offers" ][ offer ][ "buyers_contract" ] = {}
                dealership[ "offers" ][ offer ][ "sellers_contract" ] = {}
                dealership[ "offers" ][ offer ][ "buyer_txid" ] = null;
                dealership[ "offers" ][ offer ][ "buyer_vout" ] = null;
                dealership[ "offers" ][ offer ][ "seller_txid" ] = null;
                dealership[ "offers" ][ offer ][ "seller_vout" ] = null;
                dealership[ "offers" ][ offer ][ "seller_address" ] = null;
                dealership[ "offers" ][ offer ][ "buyer_address" ] = null;
                var hd = document.createElement( "h2" );
                hd.innerText = "waiting for someone to take your offer";
                $( '.procedure' ).append( hd );
            }
        </script>
        <script>
            //PROCEDURE

            //seller clicks "Sell your new utxo" and runs var sellers_privkey = dealership.getPrivateKey() and var sellers_pubkey = dealership.getPublicKey( sellers_privkey )
            //seller makes sellers_pubkey a data-pubkey="" attribute of each offer button
            //buyer gets sellers_pubkey when he selects an offer and calls dealership.prepBuyer( sellers_pubkey )
            //buyer sends 4_000 sats to dealership.buyers_contract.contract.address
            //buyer runs var txinfo = await dealership.addressReceivedMoneyInThisTx( dealership.buyers_contract.contract.address, "testnet/" )
            //buyer runs dealership[ "buyer_txid" ] = txinfo[ 0 ]
            //buyer runs dealership[ "buyer_vout" ] = txinfo[ 1 ]
            //buyer runs dealership[ "buyer_address" ] = some_bitcoin_address
            //buyer runs var buyers_contract = dealership.buyers_contract.contract
            //buyer sends the variables "buyers_contract" and "some_bitcoin_address" to seller
            //seller takes "buyers_contract" and "some_bitcoin_address" from buyer
            //seller runs var txinfo = await dealership.addressReceivedMoneyInThisTx( buyers_contract.address, "testnet/" )
            //seller checks if txinfo[ 2 ] == 4_000 and fails if not
            //seller runs dealership[ "buyer_txid" ] = txinfo[ 0 ]
            //seller runs dealership[ "buyer_vout" ] = txinfo[ 1 ]
            //seller runs dealership[ "buyer_address" ] = some_bitcoin_address
            //seller runs dealership.buyers_contract.contract = buyers_contract
            //seller calls dealership.prepSeller( sellers_privkey )
            //seller sends 3_000 sats to dealership.sellers_contract.contract.address
            //seller runs var txinfo = await dealership.addressReceivedMoneyInThisTx( dealership.sellers_contract.contract.address, "testnet/" )
            //seller runs dealership[ "seller_txid" ] = txinfo[ 0 ]
            //seller runs dealership[ "seller_vout" ] = txinfo[ 1 ]
            //seller runs dealership[ "seller_address" ] = another_bitcoin_address
            //seller runs var sellers_contract = dealership.sellers_contract.contract
            //seller sends the variables "sellers_contract" and another_bitcoin_address to buyer
            //buyer takes "sellers_contract" and another_bitcoin_address from seller
            //buyer runs var txinfo = await dealership.addressReceivedMoneyInThisTx( sellers_contract.address, "testnet/" )
            //seller checks if txinfo[ 2 ] == 3_000 and fails if not
            //if buyer fails he should run var txhex = await dealership.refundBuyer( destination ) and broadcast the tx after 10 blocks
            //buyer runs dealership[ "seller_txid" ] = txinfo[ 0 ]
            //buyer runs dealership[ "seller_vout" ] = txinfo[ 1 ]
            //buyer runs dealership[ "seller_address" ] = another_bitcoin_address
            //buyer runs dealership.sellers_contract.contract = sellers_contract
            //buyer runs var buyer_sig = await dealership.signContractAsBuyer()
            //buyer runs var buyer_preimage = dealership.buyers_contract.preimage
            //buyer sends buyer_sig and buyer_preimage to seller
            //seller checks if buyer_preimage hashes to dealership.sellers_contract.contract.hash and fails if not
            //if seller fails he should run var txhex = await dealership.refundSeller() and broadcast the tx after 5 blocks
            //seller runs var txhex = await dealership.useMultisigAsSeller( dealership.sellers_contract.privkey2, buyer_sig ) and broadcasts the tx immediately
            //seller runs var seller_sig = await dealership.signContractAsSeller()
            //seller sends seller_sig to buyer

            //buyer runs var txhex = await dealership.useMultisigAsBuyer( seller_sig ) and broadcasts the tx immediately
        </script>
        <script>
            //first the buyer creates an htlc and deposits his coins inside
            //the buyer should be able to take the coins after the timelock
            //but the seller should be able to take them with the preimage
            //next the seller creates an htlc and deposits a coinbase inside
            //the seller should be able to take the coins after the timelock
            //but the buyer should be able to take them with the preimage
            //the buyer's timelock should be longer than the seller's otherwise
            //the buyer could wait til his own timelock expires, then sweep
            //the funds from his own htlc using the timelock path, then
            //sweep the funds from the seller's htlc using the preimage before
            //the seller's timelock expires, thus taking the seller's money
            //without the seller being able to reimburse himself
            //also both htlcs should use the same hash which the buyer knows
            //when the coinbase matures the buyer should disclose the preimage
            //to the seller
            //then the seller should send the buyer a sig so he can withdraw
            //from the seller's htlc using the multisig path
            //then the buyer should send the seller a sig so he can withdraw
            //from the buyer's htlc using the multisig path
            //TESTING
            //to test the script I need to specify privkeys for the buyer
            //and the seller, then send money to the buyer's htlc [done]
            //then I should see if I can spend the money as the buyer using
            //the timelock path (before and after it expires) [done]
            //then I should see if I can spend the money as the seller using
            //the preimage path [done]
            //then I should see if I can spend the money as the seller using
            //the multisig path [done]
            //then I should create the seller's htlc and send a coinbase to it [done]
            //then I should see if I can spend the money as the seller using
            //the timelock path (before and after it expires -- remember that it
            //has a shorter timelock) [done]
            //then I should see if I can spend the money as the buyer using
            //the preimage path (before and after the coinbase matures) [done]
            //then I should see if I can spend the money as the buyer using
            //the mutlisig path (before and after the coinbase matures) [done]
        </script>
    </body>
</html>
